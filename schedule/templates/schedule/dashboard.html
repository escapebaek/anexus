{% extends 'base.html' %}
{% load static %}
{% load dict_extras %} 
{% block custom_css %}
  <link href="{% static 'css/pages/schedule_dashboard.css' %}" rel="stylesheet" />
{% endblock %}
{# load our custom filter #}

{% block page_content %}
{% csrf_token %}
<div class="dashboard-container">
  <div class="dashboard-hero">
    <div class="hero-content">
      <h1 class="hero-title">Surgery Schedule Dashboard</h1>
      <p class="hero-subtitle">Memo Loading Requires 2~3 seconds</p>
    </div>
  </div>

  <div class="schedule-wrapper">
    {% if schedule_by_room %}
      <div class="schedule-grid">
        {% for room, schedules in schedule_by_room.items %}
          <!-- Default state: folded -->
          <div class="schedule-card collapsed">
            <div class="room-header">
              <div class="room-info">
                <h3 class="room-title">{{ room }}</h3>
              </div>
              <!-- Toggle button default text "Open" because card is folded -->
              <button class="toggle-room" onclick="toggleRoom(this)">Open</button>
            </div>

            <!-- Full schedule timeline (hidden by default) -->
            <div class="schedule-timeline" style="display: none;">
              {% for schedule in schedules %}
                <div class="timeline-item" data-status="{{ schedule.status }}">
                  <div class="timeline-status">
                    <span class="status-indicator"></span>
                  </div>
                  <div class="timeline-time">
                    <span class="time">{{ schedule.time_slot }}</span>
                    <span class="duration">{{ schedule.duration }}분</span>
                  </div>
                  <div class="timeline-content">
                    <h4 class="surgery-name">{{ schedule.surgery_name }}</h4>
                    <div class="surgery-details">
                      <span class="detail-item">
                        <i class="fas fa-user-md"></i>
                        {{ schedule.surgeon }}
                      </span>
                    </div>
                    <div class="patient-info">
                      <span class="patient-name">
                        <i class="fas fa-user"></i>
                        {{ schedule.patient_name }}
                      </span>
                      <span class="patient-tag">{{ schedule.patient_info }}</span>
                      <button class="memo-btn"
                              onclick="openMemoModal('{{ schedule.id }}', '{{ schedule.patient_name }}')">
                        <i class="fas fa-pen-fancy"></i>
                      </button>
                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>

            <!-- Summary view (visible by default when folded) -->
            <div class="schedule-summary" style="display: block;">
              {% with summary=summary_by_room|get_item:room %}
                {% if summary.ongoing %}
                  <div class="timeline-item" data-status="{{ summary.ongoing.status }}">
                    <div class="timeline-status">
                      <span class="status-indicator"></span>
                    </div>
                    <div class="timeline-time">
                      <span class="time">{{ summary.ongoing.time_slot }}</span>
                      <span class="duration">{{ summary.ongoing.duration }}분</span>
                    </div>
                    <div class="timeline-content">
                      <h4 class="surgery-name">{{ summary.ongoing.surgery_name }}</h4>
                      <div class="surgery-details">
                        <span class="detail-item">
                          <i class="fas fa-user-md"></i>
                          {{ summary.ongoing.surgeon }}
                        </span>
                      </div>
                      <div class="patient-info">
                        <span class="patient-name">
                          <i class="fas fa-user"></i>
                          {{ summary.ongoing.patient_name }}
                        </span>
                        <span class="patient-tag">{{ summary.ongoing.patient_info }}</span>
                        <!-- Memo button in summary view -->
                        <button class="memo-btn"
                                onclick="openMemoModal('{{ summary.ongoing.id }}', '{{ summary.ongoing.patient_name }}')">
                          <i class="fas fa-pen-fancy"></i>
                        </button>
                      </div>
                    </div>
                  </div>
                {% else %}
                  <div class="timeline-item no-ongoing">
                    <div class="timeline-content">
                      <h4>No ongoing surgery</h4>
                    </div>
                  </div>
                {% endif %}

                <div class="summary-counts">
                  {% if summary.pending %}
                    <span class="pending-count">Remaining: {{ summary.pending }}</span>
                  {% endif %}
                  {% if summary.finished %}
                    <span class="finished-count">Finished: {{ summary.finished }}</span>
                  {% endif %}
                </div>
              {% endwith %}
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="empty-state">
        <i class="fas fa-calendar-times"></i>
        <h3>등록된 수술 일정이 없습니다</h3>
        <p>새로운 수술 일정을 업로드해주세요.</p>
        <button class="btn-upload-empty">일정 업로드</button>
      </div>
    {% endif %}

    <!-- Always show the file upload section -->
    <div class="upload-section">
      <div class="upload-card">
        <div class="upload-content">
          <div class="upload-header">
            <div class="upload-icon">
              <i class="fas fa-file-upload"></i>
            </div>
            <h3>새로운 수술 스케줄 업로드</h3>
            <p class="upload-description">
              엑셀 파일을 업로드하여 수술 일정을 등록하세요
            </p>
          </div>
          <form method="post" enctype="multipart/form-data" class="upload-form" id="uploadForm">
            {% csrf_token %}
            <div class="file-drop-area">
              <input type="file" name="file" id="fileInput" class="file-input" accept=".xlsx,.xls"/>
              <label for="fileInput" class="file-label">
                <i class="fas fa-cloud-upload-alt"></i>
                <span>파일을 선택하거나 끌어다 놓으세요</span>
                <span class="file-type-hint">Supported: Excel (.xlsx, .xls)</span>
              </label>
            </div>
            <div class="upload-actions">
              <button type="submit" name="action" value="update" class="btn-upload btn-update">
                <i class="fas fa-sync-alt"></i>
                스케줄 업데이트
              </button>
              <button type="submit" name="action" value="replace" class="btn-upload btn-replace">
                <i class="fas fa-upload"></i>
                전체 교체
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Memo Modal (unchanged) -->
<div id="memoModal" class="memo-modal">
  <div class="memo-modal-content">
    <div class="memo-modal-header">
      <div class="memo-header-content">
        <h3 id="memoPatientName"></h3>
        <span class="memo-subtitle">환자 메모</span>
      </div>
      <button class="close-modal" onclick="closeMemoModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="memo-modal-body">
      <textarea id="memoText" class="memo-textarea" placeholder="환자에 대한 메모를 입력하세요..."></textarea>
      <div class="memo-modal-footer">
        <button class="btn-save" onclick="saveMemoAndClose()">
          저장하기
          <i class="fas fa-check"></i>
        </button>
      </div>
    </div>
  </div>
</div>
<script>
      let currentScheduleId = null;

  // Toggle function: if collapsed (default) then "Open" shows full timeline; if open, then "Fold" returns to summary.
  function toggleRoom(button) {
    var card = button.closest(".schedule-card");
    var timeline = card.querySelector(".schedule-timeline");
    var summary = card.querySelector(".schedule-summary");
    if (card.classList.contains("collapsed")) {
      // Expand: show full timeline and hide summary
      card.classList.remove("collapsed");
      timeline.style.display = "block";
      summary.style.display = "none";
      button.textContent = "Fold";
    } else {
      // Collapse: hide timeline and show summary
      card.classList.add("collapsed");
      timeline.style.display = "none";
      summary.style.display = "block";
      button.textContent = "Open";
    }
  }

  function openMemoModal(scheduleId, patientName) {
    currentScheduleId = scheduleId;
    const modal = document.getElementById("memoModal");
    const patientNameElement = document.getElementById("memoPatientName");
    const memoText = document.getElementById("memoText");

    patientNameElement.textContent = patientName;
    modal.classList.add("active");

    // Get CSRF token
    const csrfToken = document.querySelector("[name=csrfmiddlewaretoken]").value;
    fetch(`/api/memos/${scheduleId}/`, {
      method: "GET",
      headers: {
        "X-CSRFToken": csrfToken,
        "Content-Type": "application/json"
      },
      credentials: "same-origin"
    })
      .then((response) => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then((data) => {
        memoText.value = data.content || "";
      })
      .catch((error) => {
        console.error("Error fetching memo:", error);
        memoText.value = "";
      });
  }

  function saveMemoAndClose() {
    const memoText = document.getElementById("memoText").value;
    const csrfToken = document.querySelector("[name=csrfmiddlewaretoken]").value;
    const saveButton = document.querySelector(".btn-save");

    if (!currentScheduleId) {
      console.error("No schedule ID found");
      alert("Error: Could not identify the current schedule.");
      return;
    }

    saveButton.disabled = true;
    saveButton.innerHTML = "Saving...";

    fetch(`/api/memos/${currentScheduleId}/`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": csrfToken,
        Accept: "application/json"
      },
      credentials: "same-origin",
      body: JSON.stringify({ content: memoText })
    })
      .then((response) =>
        response.text().then((text) => {
          try {
            return JSON.parse(text);
          } catch (e) {
            console.error("Response was not JSON:", text);
            throw new Error("Server returned invalid JSON response");
          }
        })
      )
      .then((data) => {
        if (data.status === "success") {
          closeMemoModal();
        } else {
          throw new Error(data.message || "Unknown error occurred");
        }
      })
      .catch((error) => {
        console.error("Error saving memo:", error);
        alert(`Failed to save memo: ${error.message}`);
      })
      .finally(() => {
        saveButton.disabled = false;
        saveButton.innerHTML = 'Save <i class="fas fa-check"></i>';
      });
  }

  function closeMemoModal() {
    const modal = document.getElementById("memoModal");
    modal.classList.remove("active");
    currentScheduleId = null;
  }

  // Close modal when clicking outside or pressing ESC
  document.addEventListener("click", (e) => {
    const modal = document.getElementById("memoModal");
    if (e.target === modal) {
      closeMemoModal();
    }
  });
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") {
      closeMemoModal();
    }
  });

  // File upload preview and drag/drop handling (unchanged)
  const fileInput = document.getElementById("fileInput");
  const fileLabel = document.querySelector(".file-label span");
  fileInput.addEventListener("change", (e) => {
    if (e.target.files.length > 0) {
      fileLabel.textContent = e.target.files[0].name;
    }
  });
  const dropArea = document.querySelector(".file-drop-area");
  ["dragenter", "dragover", "dragleave", "drop"].forEach((eventName) => {
    dropArea.addEventListener(eventName, preventDefaults, false);
  });
  function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
  }
  ["dragenter", "dragover"].forEach((eventName) => {
    dropArea.addEventListener(eventName, highlight, false);
  });
  ["dragleave", "drop"].forEach((eventName) => {
    dropArea.addEventListener(eventName, unhighlight, false);
  });
  function highlight(e) {
    dropArea.classList.add("highlight");
  }
  function unhighlight(e) {
    dropArea.classList.remove("highlight");
  }
  dropArea.addEventListener("drop", handleDrop, false);
  function handleDrop(e) {
    const dt = e.dataTransfer;
    const files = dt.files;
    fileInput.files = files;
    fileLabel.textContent = files[0].name;
  }
    </script>
    {% endblock %}
  </div>
</div>
