{% extends 'base.html' %} {% load exam_filters %} 
{% load markdown_extras %} 
{% block extra_css %}
<style>
  .markdown-content {
    line-height: 1.6;
    color: #333;
  }

  .markdown-content h1,
  .markdown-content h2,
  .markdown-content h3,
  .markdown-content h4,
  .markdown-content h5,
  .markdown-content h6 {
    margin: 1em 0 0.5em 0;
    font-weight: bold;
    color: #2c3e50;
  }

  .markdown-content h1 {
    font-size: 1.5em;
  }
  .markdown-content h2 {
    font-size: 1.3em;
  }
  .markdown-content h3 {
    font-size: 1.1em;
  }

  .markdown-content p {
    margin: 0.8em 0;
  }

  .markdown-content strong {
    font-weight: bold;
    color: #2c3e50;
  }

  .markdown-content em {
    font-style: italic;
    color: #555;
  }

  .markdown-content code {
    background-color: #f8f9fa;
    padding: 0.2em 0.4em;
    border-radius: 3px;
    font-family: "Monaco", "Consolas", "Courier New", monospace;
    font-size: 0.9em;
    color: #d63384;
  }

  .markdown-content pre {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 5px;
    padding: 1em;
    overflow-x: auto;
    margin: 1em 0;
  }

  .markdown-content pre code {
    background: none;
    padding: 0;
    color: #333;
  }

  .markdown-content blockquote {
    border-left: 4px solid #007bff;
    background-color: #f8f9fa;
    margin: 1em 0;
    padding: 0.8em 1em;
    font-style: italic;
  }

  .markdown-content ul,
  .markdown-content ol {
    margin: 0.8em 0;
    padding-left: 2em;
  }

  .markdown-content li {
    margin: 0.3em 0;
  }

  .markdown-content table {
    width: 100%;
    border-collapse: collapse;
    margin: 1em 0;
    font-size: 0.9em;
  }

  .markdown-content table th,
  .markdown-content table td {
    border: 1px solid #dee2e6;
    padding: 0.6em;
    text-align: left;
  }

  .markdown-content table th {
    background-color: #e9ecef;
    font-weight: bold;
  }

  .markdown-content table tbody tr:nth-child(even) {
    background-color: #f8f9fa;
  }

  .markdown-content a {
    color: #007bff;
    text-decoration: none;
  }

  .markdown-content a:hover {
    text-decoration: underline;
  }

  /* ?熬곣뫀??????쒓낮???繹먮끏?????れ삀????????*/
  .markdown-content .highlight {
    background-color: #f8f9fa;
    border-radius: 5px;
    padding: 1em;
    margin: 1em 0;
  }

  .markdown-content .highlight .c {
    color: #8e908c;
  } /* Comment */
  .markdown-content .highlight .k {
    color: #8959a8;
  } /* Keyword */
  .markdown-content .highlight .s {
    color: #718c00;
  } /* String */
  .markdown-content .highlight .nf {
    color: #4271ae;
  } /* Name.Function */
  .markdown-content .highlight .nb {
    color: #f5871f;
  } /* Name.Builtin */
</style>
{% endblock %} {% block page_content %}
<!-- ?棺??짆?승?????곷츉???源낇꼧 -->
<div
  id="loadingOverlay"
  class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
  style="
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.5);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1050;
  "
>
  <div class="bg-white p-6 rounded-lg shadow-xl text-center">
    <div
      class="animate-spin rounded-full h-12 w-12 border-4 border-blue-500 border-t-transparent mx-auto"
      style="
        animation: spin 1s linear infinite;
        border-radius: 50%;
        width: 3rem;
        height: 3rem;
        border-width: 4px;
        border-color: #3b82f6;
        border-top-color: transparent;
        margin: auto;
      "
    ></div>
    <p class="mt-4 text-gray-700 font-medium">?롪퍒???좊ご??釉띾쐞????노츎 繞벿살탳????덈펲...</p>
  </div>
</div>

<!-- Hero Section -->
<div
  class="hero-section position-relative d-flex flex-column justify-content-center align-items-center"
>
  <div class="hero-overlay"></div>
  <div class="hero-content text-center">
    <h1 class="hero-title animate-fade-in">{{ exam.title }}</h1>
    <p class="hero-subtitle animate-fade-in-delayed">
      ?熬곣뫕?????쒖굣????댁Ŧ ?獄???????댁졑???筌먦끉逾?????筌뤾쑴??
    </p>
    <div class="timer-controls animate-fade-in-delayed">
      <div class="timer-input-group">
        <input
          type="number"
          id="set-timer-input"
          class="form-control"
          min="1"
          value="60"
          placeholder="??
        />
        <button id="start-exam-btn" class="btn-hero">???ロ벍 ??戮곗굚</button>
        <button
          id="end-exam-btn"
          class="btn-action-glass danger"
          style="display: none"
        >
          <i class="fas fa-stop-circle"></i> ???ロ벍 ??リ턁筌?        </button>
      </div>
      <div id="timer-display" class="timer-display">00:00</div>
    </div>
  </div>
  <div class="hero-wave">
    <svg viewBox="0 0 1440 320" preserveAspectRatio="none">
      <path
        fill="currentColor"
        d="M0,96L48,112C96,128,192,160,288,186.7C384,213,480,235,576,213.3C672,192,768,128,864,128C960,128,1056,192,1152,208C1248,224,1344,192,1392,176L1440,160L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"
      ></path>
    </svg>
  </div>
</div>

<!-- Questions Section -->
<div class="questions-section questions-left-align">
  <div class="container">
    <form id="exam-form" method="POST">
      {% csrf_token %}
      <div class="row g-4">
        {% for question in questions %}
        <div class="col-12">
          <div
            id="q_{{ question.id }}"
            class="question-card animate-fade-in"
            data-correct-option="{{ question.correct_option }}"
            data-qindex="{{ forloop.counter }}"
          >
            <!-- ?釉뚮궙壤???뺢퀗???-->
            <div
              class="bookmark-button {% if question.is_bookmarked %}bookmarked{% endif %}"
              data-question-id="{{ question.id }}"
              onclick="toggleBookmark({{ question.id }}, this)"
            >
              <i class="fas fa-star"></i>
            </div>

            <!-- ?熬곣뫖六??釉뚮궙壤???뺢퀗???-->
            <div
              class="temp-bookmark-button"
              data-question-id="{{ question.id }}"
              data-qindex="{{ forloop.counter }}"
              onclick="toggleTempBookmark({{ question.id }}, {{ forloop.counter }}, this)"
              title="?熬곣뫖六??釉뚮궙壤??
            >
              <i class="fas fa-thumbtack"></i>
            </div>

            <div class="question-content">
              <!-- ?곸궠??誘ㅒ?μ쪚????戮?뻣 -->
              {% if question.category %}
              <div class="question-category-box">
                <i class="fas fa-tags"></i>
                <span>{{ question.category.name }}</span>
              </div>
              {% endif %}

              <div class="question-text">{{ question.question_text|safe }}</div>

              <!-- ?リ옇???????嶺뚯솘? ??戮?뻣 -->
              {% if question.image %}
              <div class="question-image">
                <img
                  src="{{ question.image.url }}"
                  alt="Question Image"
                  class="img-fluid"
                />
              </div>
              {% endif %}

              <!-- ???됱Ŧ ?怨뺣뼺?: ??ルㅏ裕?????됯껀????戮?뻣 -->
              {% if question.get_youtube_embed_id %}
              <div class="question-video">
                <div
                  class="video-container"
                  style="
                    position: relative;
                    width: 100%;
                    height: 0;
                    padding-bottom: 56.25%;
                    margin: 15px 0;
                  "
                >
                  <iframe
                    id="youtube_{{ question.id }}"
                    src="https://www.youtube.com/embed/{{ question.get_youtube_embed_id }}?enablejsapi=1&rel=0"
                    frameborder="0"
                    allowfullscreen
                    style="
                      position: absolute;
                      top: 0;
                      left: 0;
                      width: 100%;
                      height: 100%;
                      border-radius: 8px;
                    "
                  ></iframe>
                </div>
                <div
                  class="video-controls"
                  style="text-align: center; margin-top: 10px"
                >
                  <button
                    type="button"
                    class="btn-action-glass"
                    onclick="playYouTube('{{ question.id }}')"
                  >
                    <i class="fas fa-play"></i> ??繹?                  </button>
                  <button
                    type="button"
                    class="btn-action-glass"
                    onclick="pauseYouTube('{{ question.id }}')"
                  >
                    <i class="fas fa-pause"></i> ??源낅뻣?筌?
                  </button>
                  <button
                    type="button"
                    class="btn-action-glass"
                    onclick="stopYouTube('{{ question.id }}')"
                  >
                    <i class="fas fa-stop"></i> ?筌?
                  </button>
                </div>
              </div>
              {% endif %}

              <div class="options-grid">
                <div class="form-check">
                  <input
                    type="radio"
                    id="option1_{{ question.id }}"
                    name="question_{{ question.id }}"
                    value="{{ question.option1 }}"
                    class="form-check-input"
                  />
                  <label
                    for="option1_{{ question.id }}"
                    class="form-check-label"
                  >{{ question.option1 }}</label>
                </div>
                <div class="form-check">
                  <input
                    type="radio"
                    id="option2_{{ question.id }}"
                    name="question_{{ question.id }}"
                    value="{{ question.option2 }}"
                    class="form-check-input"
                  />
                  <label
                    for="option2_{{ question.id }}"
                    class="form-check-label"
                  >{{ question.option2 }}</label>
                </div>
                <div class="form-check">
                  <input
                    type="radio"
                    id="option3_{{ question.id }}"
                    name="question_{{ question.id }}"
                    value="{{ question.option3 }}"
                    class="form-check-input"
                  />
                  <label
                    for="option3_{{ question.id }}"
                    class="form-check-label"
                  >{{ question.option3 }}</label>
                </div>
                <div class="form-check">
                  <input
                    type="radio"
                    id="option4_{{ question.id }}"
                    name="question_{{ question.id }}"
                    value="{{ question.option4 }}"
                    class="form-check-input"
                  />
                  <label
                    for="option4_{{ question.id }}"
                    class="form-check-label"
                  >{{ question.option4 }}</label>
                </div>
                {% if question.option5 %}
                <div class="form-check">
                  <input
                    type="radio"
                    id="option5_{{ question.id }}"
                    name="question_{{ question.id }}"
                    value="{{ question.option5 }}"
                    class="form-check-input"
                  />
                  <label
                    for="option5_{{ question.id }}"
                    class="form-check-label"
                  >{{ question.option5 }}</label>
                </div>
                {% endif %}
              </div>

              <!-- Action Buttons -->
              <div class="action-buttons">
                <button
                  type="button"
                  class="btn-action-glass"
                  onclick="toggleDisplay('answer_{{ question.id }}')"
                >
                  <i class="fas fa-check-circle"></i> ?筌먲퐢堉??곌랜??뵳?                </button>
                <button
                  type="button"
                  class="btn-action-glass"
                  onclick="toggleDisplay('explanation_{{ question.id }}')"
                >
                  <i class="fas fa-info-circle"></i> ??怨댄맟 ?곌랜??뵳?                </button>
                {% if question.comment_image %}
                <button
                  type="button"
                  class="btn-action-glass"
                  onclick="toggleDisplay('image_{{ question.id }}')"
                >
                  <i class="fas fa-image"></i> ????嶺뚯솘? ?곌랜??뵳?                </button>
                {% endif %}
                <!-- ???됱Ŧ ?怨뺣뼺?: ??怨댄맟 ???됯껀???뺢퀗???-->
                {% if question.get_comment_youtube_embed_id %}
                <button
                  type="button"
                  class="btn-action-glass"
                  onclick="toggleDisplay('video_explanation_{{ question.id }}')"
                >
                  <i class="fas fa-video"></i> ??怨댄맟 ??⑤㈇留?                </button>
                {% endif %}
              </div>

              <!-- ?筌먲퐢堉???戮?뻣 ?꾩룆踰??-->
              <div
                id="answer_{{ question.id }}"
                class="answer-display-box hidden"
              >
                <div class="answer-display-title">
                  <i class="fas fa-check-circle"></i> ?筌먲퐢堉?r\n                </div>
                <div class="answer-display-content">
                  {{ question.correct_option }}
                </div>
              </div>

              <!-- ??怨댄맟 ??戮?뻣 ?꾩룆踰??(Markdown 嶺뚯솘????怨뺣뼺?) -->
              <div
                id="explanation_{{ question.id }}"
                class="explanation-display-box hidden"
              >
                <div class="explanation-display-title">
                  <i class="fas fa-info-circle"></i> ??怨댄맟\r\n                </div>
                <div class="explanation-display-content markdown-content">
                  {{ question.comment|markdown }}
                </div>
              </div>

              <!-- ????嶺뚯솘? ??戮?뻣 ?꾩룆踰??-->
              {% if question.comment_image %}
              <div
                id="image_{{ question.id }}"
                class="image-display-box hidden"
              >
                <div class="image-display-title">
                  <i class="fas fa-image"></i> ??㉱??????嶺뚯솘?\r\n                </div>
                <img
                  src="{{ question.comment_image.url }}"
                  alt="Explanation Image"
                  class="img-fluid rounded"
                />
              </div>
              {% endif %}

              <!-- ???됱Ŧ ?怨뺣뼺?: ??怨댄맟 ???됯껀????戮?뻣 ?꾩룆踰??-->
              {% if question.get_comment_youtube_embed_id %}
              <div
                id="video_explanation_{{ question.id }}"
                class="video-explanation-box hidden"
              >
                <div class="video-explanation-title">
                  <i class="fas fa-video"></i> ??怨댄맟 ???됯껀??r\n                <div
                  class="video-container"
                  style="
                    position: relative;
                    width: 100%;
                    height: 0;
                    padding-bottom: 56.25%;
                    margin: 15px 0;
                  "
                >
                  <iframe
                    id="comment_youtube_{{ question.id }}"
                    src="https://www.youtube.com/embed/{{ question.get_comment_youtube_embed_id }}?enablejsapi=1&rel=0"
                    frameborder="0"
                    allowfullscreen
                    style="
                      position: absolute;
                      top: 0;
                      left: 0;
                      width: 100%;
                      height: 100%;
                      border-radius: 8px;
                    "
                  ></iframe>
                </div>
                <div
                  class="video-controls"
                  style="text-align: center; margin-top: 10px"
                >
                  <button
                    type="button"
                    class="btn-action-glass"
                    onclick="playCommentYouTube('{{ question.id }}')"
                  >
                    <i class="fas fa-play"></i> ??繹?                  </button>
                  <button
                    type="button"
                    class="btn-action-glass"
                    onclick="pauseCommentYouTube('{{ question.id }}')"
                  >
                    <i class="fas fa-pause"></i> ??源낅뻣?筌?
                  </button>
                  <button
                    type="button"
                    class="btn-action-glass"
                    onclick="stopCommentYouTube('{{ question.id }}')"
                  >
                    <i class="fas fa-stop"></i> ?筌?
                  </button>
                </div>
              </div>
              {% endif %}
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </form>
  </div>
</div>

<style>
  .options-grid .form-check { cursor: pointer; }
  .options-grid .form-check-label { cursor: pointer; display: block; }
  .options-grid .form-check-input { cursor: pointer; }
  /* Ensure no overlay blocks clicks in options grid */
  .options-grid * { pointer-events: auto; }
</style>

<!-- YouTube API ?棺??짆?삠궘?-->
<!-- Floating panel: Temporary Bookmarks -->
<div id=\"tempBookmarkPanel\" class=\"temp-bookmark-panel\">
  <div class=\"panel-header\">
    <span><i class=\"fas fa-thumbtack\"></i> Temp Bookmarks</span>
    <div class=\"panel-actions\">
      <button class=\"btn btn-sm btn-outline-secondary\" id=\"togglePanelBtn\">Minimize</button>
      <button class=\"btn btn-sm btn-outline-danger\" id=\"clearTempBookmarksBtn\">Clear</button>
    </div>
  </div>
  <div class=\"panel-body\">
    <div id=\"tempBookmarkList\" class=\"bookmark-list\"></div>
  </div>
  <div class=\"panel-footer small text-muted\">Click to jump to question</div>
  <button class=\"panel-fab btn btn-primary\" id=\"openPanelFab\" title=\"Open temp bookmarks\">\n    <i class=\"fas fa-thumbtack\"></i>\n  </button>
</div><script src="https://www.youtube.com/iframe_api"></script>

<script>
  // Make entire option block clickable and robust to nested elements
  document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.options-grid .form-check').forEach(function(fc){
      fc.addEventListener('click', function(e) {
        const input = this.querySelector('input[type="radio"]');
        if (!input) return;
        if (e.target === input || (e.target.tagName === 'LABEL' && e.target.htmlFor === input.id)) return;
        input.checked = true;
        input.dispatchEvent(new Event('change', { bubbles: true }));
      });
    });
  });
</script>

<style>
  /* Temp bookmark button sits next to the permanent star */
  .temp-bookmark-button {
    position: absolute;
    top: 1.25rem;
    left: 1.25rem;
    background: rgba(255,255,255,0.9);
    border: 1px solid rgba(0,0,0,0.1);
    padding: 8px;
    border-radius: 50%;
    cursor: pointer;
    z-index: 4;
    transition: transform .15s ease, box-shadow .15s ease, background .15s ease;
  }
  .temp-bookmark-button i { color: var(--text-muted); }
  .temp-bookmark-button.active i { color: var(--primary-dark); }
  .temp-bookmark-button:hover { transform: scale(1.08); box-shadow: 0 4px 10px rgba(0,0,0,0.08); }

  /* Floating panel */
  .temp-bookmark-panel {
    position: fixed;
    right: 16px;
    top: 110px;
    width: 260px;
    background: rgba(255,255,255,0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.25);
    border: 1px solid rgba(255,255,255,0.25);
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.08);
    z-index: 1051;
    overflow: hidden;
  }
  /* 癲ル슔?됭짆??????ㅺ컼?? ????밸쭬癲???影??탿???袁⑸즴???????????? */
  .temp-bookmark-panel.collapsed { width: 56px; }
  .temp-bookmark-panel.collapsed .panel-header span { display:none; }
  .temp-bookmark-panel.collapsed .panel-body,
  .temp-bookmark-panel.collapsed .panel-footer,
  .temp-bookmark-panel.collapsed .panel-actions .btn-outline-danger { display:none; }
  .temp-bookmark-panel .panel-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 10px 12px; border-bottom: 1px solid rgba(0,0,0,0.06);
    font-weight: 600;
  }
  .temp-bookmark-panel .panel-body { padding: 10px 12px; max-height: 320px; overflow: auto; }
  .temp-bookmark-panel .panel-footer { padding: 6px 12px; border-top: 1px solid rgba(0,0,0,0.06); background: #fafafa; }
  .temp-bookmark-panel .bookmark-list { display: flex; flex-wrap: wrap; gap: 6px; }
  .temp-bookmark-panel .bookmark-chip { display: inline-flex; align-items: center; justify-content: center; min-width: 36px; height: 32px; padding: 0 10px; border-radius: 16px; background: var(--primary-alpha); border: 1px solid var(--primary-alpha); color: var(--primary-dark); font-weight: 600; cursor: pointer; text-decoration: none; }
  .temp-bookmark-panel .bookmark-chip:hover { background: #ffe9c7; }
  .temp-bookmark-panel .panel-fab { position: absolute; right: 12px; bottom: 12px; display: none; }

  @media (max-width: 992px) {
    .temp-bookmark-panel { width: 210px; }
  }
  @media (max-width: 768px) {
    .temp-bookmark-panel { right: 8px; width: 190px; }
  }
</style>

<script>
  // Temporary bookmark (session-only) logic
(function(){
  const panel = document.getElementById('tempBookmarkPanel');
  if (!panel) return;
  const listEl = document.getElementById('tempBookmarkList');
  const btnHide = document.getElementById('togglePanelBtn');
  const btnClear = document.getElementById('clearTempBookmarksBtn');
  const NAV_HEIGHT = (document.getElementById('mainNavbar')?.offsetHeight || 64) + 12;
  const STORAGE_KEY = 'tempBookmarks_exam_{{ exam.id }}';

  function loadTemp(){ try { return JSON.parse(sessionStorage.getItem(STORAGE_KEY) || '{}'); } catch(e){ return {}; } }
  function saveTemp(state){ sessionStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

  let temp = loadTemp(); // { [qid]: index }

  function updateButtons(){
    document.querySelectorAll('.temp-bookmark-button').forEach(function(btn){
      const qid = btn.getAttribute('data-question-id');
      if (qid && temp[qid]) btn.classList.add('active'); else btn.classList.remove('active');
    });
  }

  function scrollToQuestion(qid){
    const el = document.getElementById('q_' + qid);
    if (!el) return;
    const y = el.getBoundingClientRect().top + window.pageYOffset - NAV_HEIGHT;
    window.scrollTo({ top: y, behavior: 'smooth' });
  }

  function renderList(){
    const entries = Object.entries(temp).map(function(pair){ return { qid: pair[0], idx: parseInt(pair[1],10)||0 }; });
    entries.sort(function(a,b){ return a.idx - b.idx; });
    listEl.innerHTML = '';
    if (entries.length === 0){
      listEl.innerHTML = '<div class="text-muted small">\uBE44\uC5B4 \uC788\uC2B5\uB2C8\uB2E4</div>';
      return;
    }
    entries.forEach(function(item){
      const a = document.createElement('a');
      a.className = 'bookmark-chip';
      a.href = '#';
      a.textContent = String(item.idx);
      a.title = '\uBB38\uC81C #'+ item.idx;
      a.addEventListener('click', function(ev){ ev.preventDefault(); scrollToQuestion(item.qid); });
      listEl.appendChild(a);
    });
  }

  window.toggleTempBookmark = function(qid, index){
    const key = String(qid);
    if (temp[key]) delete temp[key]; else temp[key] = index;
    saveTemp(temp);
    updateButtons();
    renderList();
  };

  if (btnHide) btnHide.addEventListener('click', function(){
    if (panel.classList.contains('collapsed')){
      panel.classList.remove('collapsed');
      this.textContent = '\uCD5C\uC18C\uD654'; // 理쒖냼??    } else {
      panel.classList.add('collapsed');
      this.textContent = '\uD3BC\uCE58\uAE30'; // ?쇱튂湲?    }
  });
  if (btnClear) btnClear.addEventListener('click', function(){
    if (!confirm('\uC784\uC2DC \uBD81\uB9C8\uD06C\uB97C \uBAA8\uB450 \uC0AD\uC81C\uD558\uC2DC\uACA0\uC2B5\uB2C8\uAE4C\?')) return;
    temp = {}; saveTemp(temp); updateButtons(); renderList();
  });

  updateButtons();
  renderList();
})();;
</script>

<script>
  let timerInterval;
  let timeRemaining;
  let youtubePlayers = {}; // YouTube ???????⑤９苑???源낃도 ???濚왿몾????좊즵??꼯??
  // YouTube API 濚욌꼬裕뼘????ш끽維???熬곣뫖痢딀뤆?  function onYouTubeIframeAPIReady() {
    // 癲ル슢?꾤땟???YouTube iframe?????????⑤９苑???縕?猿녿뎨??    {% for question in questions %}
      {% if question.get_youtube_embed_id %}
        youtubePlayers['youtube_{{ question.id }}'] = new YT.Player('youtube_{{ question.id }}');
      {% endif %}
      {% if question.get_comment_youtube_embed_id %}
        youtubePlayers['comment_youtube_{{ question.id }}'] = new YT.Player('comment_youtube_{{ question.id }}');
      {% endif %}
    {% endfor %}
  }

  // YouTube ??????????筌?苑???縕???  function playYouTube(questionId) {
    const player = youtubePlayers['youtube_' + questionId];
    if (player && player.playVideo) {
      player.playVideo();
    }
  }

  function pauseYouTube(questionId) {
    const player = youtubePlayers['youtube_' + questionId];
    if (player && player.pauseVideo) {
      player.pauseVideo();
    }
  }

  function stopYouTube(questionId) {
    const player = youtubePlayers['youtube_' + questionId];
    if (player && player.stopVideo) {
      player.stopVideo();
    }
  }

  function playCommentYouTube(questionId) {
    const player = youtubePlayers['comment_youtube_' + questionId];
    if (player && player.playVideo) {
      player.playVideo();
    }
  }

  function pauseCommentYouTube(questionId) {
    const player = youtubePlayers['comment_youtube_' + questionId];
    if (player && player.pauseVideo) {
      player.pauseVideo();
    }
  }

  function stopCommentYouTube(questionId) {
    const player = youtubePlayers['comment_youtube_' + questionId];
    if (player && player.stopVideo) {
      player.stopVideo();
    }
  }

  // ?????????筌먦끉援????れ삀?????縕??  function makeDraggable(element) {
    let offsetX, offsetY;

    function onMouseDown(e) {
      if (e.target.closest('.fixed-timer-end-btn')) {
        return;
      }
      e.preventDefault();
      element.classList.add('dragging');

      offsetX = e.clientX - element.offsetLeft;
      offsetY = e.clientY - element.offsetTop;

      element.style.right = 'auto';

      document.addEventListener('mousemove', onMouseMove);
      document.addEventListener('mouseup', onMouseUp, { once: true });
    }

    function onMouseMove(e) {
      const newLeft = e.clientX - offsetX;
      const newTop = e.clientY - offsetY;
      element.style.left = `${newLeft}px`;
      element.style.top = `${newTop}px`;
    }

    function onMouseUp() {
      element.classList.remove('dragging');
      document.removeEventListener('mousemove', onMouseMove);
    }

    element.addEventListener('mousedown', onMouseDown);
  }

  function startTimer(duration) {
    if (timerInterval) clearInterval(timerInterval);

    timeRemaining = duration * 60;
    document.getElementById("start-exam-btn").style.display = "none";
    document.getElementById("end-exam-btn").style.display = "inline-block";
    document.getElementById("set-timer-input").disabled = true;

    let fixedTimer = document.querySelector(".fixed-timer");
    if (!fixedTimer) {
      fixedTimer = document.createElement("div");
      fixedTimer.className = "fixed-timer";
      fixedTimer.innerHTML = `
        <div id="fixed-timer-display" class="timer-display">00:00</div>
        <button class="fixed-timer-end-btn" onclick="endExamWithConfirmation()" title="?????쾷 ???ろ꼤嶺?>
          <i class="fas fa-power-off"></i>
        </button>
      `;
      document.body.appendChild(fixedTimer);
      makeDraggable(fixedTimer);
    }

    timerInterval = setInterval(() => {
      if (timeRemaining <= 0) {
        clearInterval(timerInterval);
        endExam();
        return;
      }
      timeRemaining--;
      const minutes = Math.floor(timeRemaining / 60);
      const seconds = timeRemaining % 60;
      const displayTime = `${minutes.toString().padStart(2, "0")}:${seconds
        .toString()
        .padStart(2, "0")}`;

      document.getElementById("timer-display").textContent = displayTime;
      const fixedTimerDisplay = document.getElementById("fixed-timer-display");
      if (fixedTimerDisplay) {
        fixedTimerDisplay.textContent = displayTime;
      }

      const currentFixedTimer = document.querySelector(".fixed-timer");
      if (timeRemaining <= 300 && currentFixedTimer) {
        currentFixedTimer.style.background = "linear-gradient(135deg, #ff6b6b, #ff4757)";
      }
    }, 1000);
  }

  function endExamWithConfirmation() {
    if (confirm("?嶺뚮㉡?ｇ빊?띿뒙??????쾷?????ろ꼤嶺??筌뚯슜六?濡ろ뜑鴉?????뉖??")) {
      endExam();
    }
  }

  function endExam() {
    clearInterval(timerInterval);
    const fixedTimer = document.querySelector(".fixed-timer");
    if (fixedTimer) fixedTimer.remove();

    // 癲ル슢?꾤땟???YouTube ?????????嶺?
    Object.values(youtubePlayers).forEach(player => {
      if (player && player.stopVideo) {
        player.stopVideo();
      }
    });

    const loadingOverlay = document.getElementById("loadingOverlay");
    loadingOverlay.classList.remove("hidden");
    loadingOverlay.style.display = "flex";

    const questionBlocks = document.querySelectorAll(".question-card");
    let numCorrect = 0, numIncorrect = 0, numUnanswered = 0, numNoanswer = 0;
    let detailedResults = [];

    // Helper: normalize answer and extract leading key
    function normalizeText(t) {
      if (!t) return '';
      let s = String(t).replace(/<[^>]*>/g, '').trim();
      // Map circled numbers to digits
      const circledMap = {
        '??:'1','??:'2','??:'3','??:'4','??:'5','??:'6','??:'7','??:'8','??:'9','??:'10'
      };
      s = s.replace(/[??브퀣沅??????????????됲??縕ョ댚?/g, m => circledMap[m] || m);
      return s;
    }
    function leadingKey(t) {
      const s = normalizeText(t);
      // Remove common wrappers like (??좊읈?), A), 1. etc and pick first significant char/digit/Korean letter
      const m = s.match(/[A-Za-z0-9??좊읈?-??/);
      return m ? m[0].toUpperCase() : '';
    }

    questionBlocks.forEach((block) => {
      const questionText = block.querySelector(".question-text").textContent.trim();
      const correctOption = block.dataset.correctOption;
      const selectedRadio = block.querySelector('input[type="radio"]:checked');
      let resultType;

      if (!correctOption || correctOption.trim() === "" || correctOption === "default") {
        numNoanswer++;
        resultType = "noanswer";
      } else if (!selectedRadio) {
        numUnanswered++;
        resultType = "unanswered";
      } else if (selectedRadio.value === correctOption || leadingKey(selectedRadio.value) === leadingKey(correctOption)) {
        numCorrect++;
        resultType = "correct";
      } else {
        numIncorrect++;
        resultType = "incorrect";
      }
      detailedResults.push({
        question: questionText,
        selected_answer: selectedRadio ? selectedRadio.value : "",
        correct_answer: correctOption || "",
        result: resultType,
      });
    });

    const resultData = {
      exam_id: "{{ exam.id }}",
      num_correct: numCorrect,
      num_incorrect: numIncorrect,
      num_unanswered: numUnanswered,
      num_noanswer: numNoanswer,
      detailed_results: detailedResults,
    };

    const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;

    fetch("/exam/save_exam_results/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": csrfToken,
      },
      body: JSON.stringify(resultData),
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.status === "ok") {
          window.location.href = `/exam/exam_results/?result_id=${data.result_id}`;
        } else {
          loadingOverlay.classList.add("hidden");
          loadingOverlay.style.display = "none";
          alert("?濡ろ뜏???????濚?????곸씔??좊읈? ?袁⑸즵獒뺣뎾????怨?????덊렡. ???怨뺣빰 ??筌먲퐣?????낆뒩??뗫빝??");
        }
      })
      .catch((error) => {
        loadingOverlay.classList.add("hidden");
        loadingOverlay.style.display = "none";
        console.error("Error:", error);
        alert("?濡ろ뜏???????濚?????곸씔??좊읈? ?袁⑸즵獒뺣뎾????怨?????덊렡. ???怨뺣빰 ??筌먲퐣?????낆뒩??뗫빝??");
      });
  }

  document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("start-exam-btn").addEventListener("click", () => {
      const duration = parseInt(document.getElementById("set-timer-input").value, 10);
      if (!isNaN(duration) && duration > 0) {
        startTimer(duration);
      } else {
        alert("???レ챺?????癰?????????쒙쭕袁?뒙?????곸죷???⑥궢猷?嶺뚮ㅎ???");
      }
    });
    document.getElementById("end-exam-btn").addEventListener("click", endExamWithConfirmation);
  });

  function toggleDisplay(id) {
    const element = document.getElementById(id);
    if (element) {
      element.classList.toggle("hidden");
    }
  }

  function toggleBookmark(questionId, button) {
    const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
    fetch(`/exam/bookmark/${questionId}/`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": csrfToken,
      },
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.status === "ok") {
          button.classList.toggle("bookmarked", data.is_bookmarked);
        } else {
          alert("??됰슢沅쇿＄??癲ル슪?ｇ몭??濚?????곸씔??좊읈? ?袁⑸즵獒뺣뎾????怨?????덊렡.");
        }
      })
      .catch((error) => {
        console.error("Error:", error);
        alert("??됰슢沅쇿＄??癲ル슪?ｇ몭??濚?????곸씔??좊읈? ?袁⑸즵獒뺣뎾????怨?????덊렡.");
      });
  }
</script>
<script>
  // ???쒓낮?꾬┼??넊???癲ル슢?꾤땟????熬곣뫕??????? ?棺??짆?삠궘????????덈틖??筌뤾퍓???
  document.addEventListener("DOMContentLoaded", function () {
    // 'explanation_'???⑥????筌믨퀣援??嚥▲꺂痢?癲ル슢?꾤땟??????⑤똾留??袁⑸즴甕???뽧걫?癲ル슓??젆?????덊렡.
    const explanationBoxes = document.querySelectorAll(
      'div[id^="explanation_"]'
    );

    explanationBoxes.forEach((box) => {
      // ???⑤똾留??袁⑸즴甕????????癲ル슢?꾤땟??????筌???釉먯뒠??????ャ뀕???筌뤾퍓???(p, ul, li ??.
      const allChildren = box.querySelectorAll(".markdown-content *");

      allChildren.forEach((child) => {
        // ?????筌???釉먯뒠????嶺뚮ㅎ?붼???????繹먮끏援?癲ル슣????'left'?????源놁젳??筌뚯슦肉???????ㅿ폍???
        child.style.textAlign = "left";
      });
    });
  });
</script>
{% endblock %}


<style>
  /* Uniform question card height across all questions */
  .questions-section .question-card { min-height: 620px; display: flex; flex-direction: column; }
  .questions-section .question-content { flex: 1 1 auto; }
  @media (max-width: 992px) { .questions-section .question-card { min-height: 540px; } }
  @media (max-width: 576px) { .questions-section .question-card { min-height: 460px; } }
</style>


