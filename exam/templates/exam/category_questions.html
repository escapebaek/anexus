{% extends 'base.html' %}
{% load static %}
{% load exam_filters %}
{% load markdown_extras %}

{% block custom_css %}
  <link href="{% static 'css/pages/exam_question_list.css' %}" rel="stylesheet" />
  <link href="{% static 'css/pages/exam_question_experience.css' %}" rel="stylesheet" />
{% endblock %}

{% block page_content %}
<!-- 로딩 오버레이 -->
<div
  id="loadingOverlay"
  class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
  style="
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.5);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1050;
  "
>
  <div class="bg-white p-6 rounded-lg shadow-xl text-center">
    <div
      class="animate-spin rounded-full h-12 w-12 border-4 border-blue-500 border-t-transparent mx-auto"
      style="
        animation: spin 1s linear infinite;
        border-radius: 50%;
        width: 3rem;
        height: 3rem;
        border-width: 4px;
        border-color: #3b82f6;
        border-top-color: transparent;
        margin: auto;
      "
    ></div>
    <p class="mt-4 text-gray-700 font-medium">결과를 불러오는 중입니다...</p>
  </div>
</div>

<!-- Hero Section -->
<div
  class="hero-section position-relative d-flex flex-column justify-content-center align-items-center"
>
  <div class="hero-overlay"></div>
  <div class="hero-content text-center">
    <h1 class="hero-title animate-fade-in">{{ category_name }}</h1>
    <p class="hero-subtitle animate-fade-in-delayed">
      엄선된 문제들로 당신의 실력을 확인해보세요.
    </p>
    <div class="exam-timer animate-fade-in-delayed">
      <div class="timer-face">
        <div class="timer-ring">
          <span id="timer-display" class="timer-digits">00:00</span>
        </div>
        <p class="timer-label">시험 타이머</p>
      </div>
      <div class="timer-console">
        <label for="set-timer-input" class="timer-input">
          <span>시험 시간 설정</span>
          <input
            type="number"
            id="set-timer-input"
            min="1"
            value="60"
            placeholder="60"
            aria-label="Timer minutes"
          />
        </label>
        <div class="timer-buttons">
          <button id="start-exam-btn" class="btn-timer primary">
            <i class="fas fa-play"></i> 시험 시작
          </button>
          <button
            id="pause-exam-btn"
            class="btn-timer secondary"
            style="display: none"
          >
            <i class="fas fa-pause"></i> 일시 정지
          </button>
          <button
            id="resume-exam-btn"
            class="btn-timer primary"
            style="display: none"
          >
            <i class="fas fa-play"></i> 재시작
          </button>
          <button
            id="end-exam-btn"
            class="btn-timer ghost"
            style="display: none"
          >
            <i class="fas fa-stop-circle"></i> 시험 종료 및 채점
          </button>
        </div>
        <p class="timer-hint">
          <i class="fas fa-lightbulb"></i>
          설정한 시간이 지나면 자동으로 결과가 제출돼요.
        </p>
      </div>
    </div>
  </div>
  <div class="hero-wave">
    <svg viewBox="0 0 1440 320" preserveAspectRatio="none">
      <path
        fill="currentColor"
        d="M0,96L48,112C96,128,192,160,288,186.7C384,213,480,235,576,213.3C672,192,768,128,864,128C960,128,1056,192,1152,208C1248,224,1344,192,1392,176L1440,160L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"
      ></path>
    </svg>
  </div>
</div>

<!-- Questions Section -->
<div class="questions-section questions-left-align">
  <div class="container">
    <form id="exam-form" method="POST">
      {% csrf_token %}
      <div class="row g-4">
        {% for question in questions %}
        <div class="col-12">
          <div
            id="q_{{ question.id }}"
            class="question-card animate-fade-in"
            data-correct-option="{{ question.correct_option }}"
            data-qindex="{{ forloop.counter }}"
          >
            <!-- 북마크 버튼 -->
            <div
              class="bookmark-button {% if question.is_bookmarked %}bookmarked{% endif %}"
              data-question-id="{{ question.id }}"
              onclick="toggleBookmark({{ question.id }}, this)"
            >
              <i class="fas fa-star"></i>
            </div>

            <!-- 임시 북마크 버튼 (시험 중 전용) -->
            <div
              class="temp-bookmark-button"
              data-question-id="{{ question.id }}"
              data-qindex="{{ forloop.counter }}"
              onclick="toggleTempBookmark({{ question.id }}, {{ forloop.counter }}, this)"
              title="임시 북마크"
            >
              <i class="fas fa-thumbtack"></i>
            </div>

            <div class="question-content">
              <!-- 카테고리 및 시험 타이틀 표시 -->
              {% if question.category or question.exam %}
              <div class="question-meta-group">
                {% if question.category %}
                <div class="question-category-box">
                  <i class="fas fa-tags"></i>
                  <span>{{ question.category.name }}</span>
                </div>
                {% endif %}
                {% if question.exam %}
                <div class="question-exam-box">
                  <i class="fas fa-file-alt"></i>
                  <span>{{ question.exam.title }}</span>
                </div>
                {% endif %}
              </div>
              {% endif %}

              <div class="question-text">{{ question.question_text|safe }}</div>

              <!-- 기존 이미지 표시 -->
              {% if question.image %}
              <div class="question-image">
                <img
                  src="{{ question.image.url }}"
                  alt="Question Image"
                  class="img-fluid"
                />
              </div>
              {% endif %}

              <!-- 새로 추가: 유튜브 동영상 표시 -->
              {% if question.get_youtube_embed_id %}
              <div class="question-video">
                <div
                  class="video-container"
                  style="
                    position: relative;
                    width: 100%;
                    height: 0;
                    padding-bottom: 56.25%;
                    margin: 15px 0;
                  "
                >
                  <iframe
                    id="youtube_{{ question.id }}"
                    src="https://www.youtube.com/embed/{{ question.get_youtube_embed_id }}?enablejsapi=1&rel=0&origin={{ request.scheme }}://{{ request.get_host }}"
                    frameborder="0"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                    referrerpolicy="strict-origin-when-cross-origin"
                    allowfullscreen
                    style="
                      position: absolute;
                      top: 0;
                      left: 0;
                      width: 100%;
                      height: 100%;
                      border-radius: 8px;
                    "
                  ></iframe>
                </div>
                <div
                  class="video-controls"
                  style="text-align: center; margin-top: 10px"
                >
                  <button
                    type="button"
                    class="btn-action-glass"
                    onclick="playYouTube('{{ question.id }}')"
                  >
                    <i class="fas fa-play"></i> 재생
                  </button>
                  <button
                    type="button"
                    class="btn-action-glass"
                    onclick="pauseYouTube('{{ question.id }}')"
                  >
                    <i class="fas fa-pause"></i> 일시정지
                  </button>
                  <button
                    type="button"
                    class="btn-action-glass"
                    onclick="stopYouTube('{{ question.id }}')"
                  >
                    <i class="fas fa-stop"></i> 정지
                  </button>
                </div>
              </div>
              {% endif %}

              <div class="options-grid">
                <div class="form-check">
                  <input
                    type="radio"
                    id="option1_{{ question.id }}"
                    name="question_{{ question.id }}"
                    value="{{ question.option1 }}"
                    class="form-check-input"
                  />
                  <label
                    for="option1_{{ question.id }}"
                    class="form-check-label"
                    >{{ question.option1 }}</label
                  >
                </div>
                <div class="form-check">
                  <input
                    type="radio"
                    id="option2_{{ question.id }}"
                    name="question_{{ question.id }}"
                    value="{{ question.option2 }}"
                    class="form-check-input"
                  />
                  <label
                    for="option2_{{ question.id }}"
                    class="form-check-label"
                    >{{ question.option2 }}</label
                  >
                </div>
                <div class="form-check">
                  <input
                    type="radio"
                    id="option3_{{ question.id }}"
                    name="question_{{ question.id }}"
                    value="{{ question.option3 }}"
                    class="form-check-input"
                  />
                  <label
                    for="option3_{{ question.id }}"
                    class="form-check-label"
                    >{{ question.option3 }}</label
                  >
                </div>
                <div class="form-check">
                  <input
                    type="radio"
                    id="option4_{{ question.id }}"
                    name="question_{{ question.id }}"
                    value="{{ question.option4 }}"
                    class="form-check-input"
                  />
                  <label
                    for="option4_{{ question.id }}"
                    class="form-check-label"
                    >{{ question.option4 }}</label
                  >
                </div>
                {% if question.option5 %}
                <div class="form-check">
                  <input
                    type="radio"
                    id="option5_{{ question.id }}"
                    name="question_{{ question.id }}"
                    value="{{ question.option5 }}"
                    class="form-check-input"
                  />
                  <label
                    for="option5_{{ question.id }}"
                    class="form-check-label"
                    >{{ question.option5 }}</label
                  >
                </div>
                {% endif %}
              </div>

              <!-- Action Buttons -->
              <div class="action-buttons">
                <button
                  type="button"
                  class="btn-action-glass"
                  onclick="toggleDisplay('answer_{{ question.id }}')"
                >
                  <i class="fas fa-check-circle"></i> 정답 보기
                </button>
                <button
                  type="button"
                  class="btn-action-glass"
                  onclick="toggleDisplay('explanation_{{ question.id }}')"
                >
                  <i class="fas fa-info-circle"></i> 해설 보기
                </button>
                {% if question.comment_image %}
                <button
                  type="button"
                  class="btn-action-glass"
                  onclick="toggleDisplay('image_{{ question.id }}')"
                >
                  <i class="fas fa-image"></i> 이미지 보기
                </button>
                {% endif %}
                <!-- 새로 추가: 해설 동영상 버튼 -->
                {% if question.get_comment_youtube_embed_id %}
                <button
                  type="button"
                  class="btn-action-glass"
                  onclick="toggleDisplay('video_explanation_{{ question.id }}')"
                >
                  <i class="fas fa-video"></i> 해설 영상
                </button>
                {% endif %}
              </div>

              <!-- 정답 표시 박스 -->
              <div
                id="answer_{{ question.id }}"
                class="answer-display-box hidden"
              >
                <div class="answer-display-title">
                  <i class="fas fa-check-circle"></i> 정답
                </div>
                <div class="answer-display-content">
                  {{ question.correct_option }}
                </div>
              </div>

              <!-- 해설 표시 박스 (Markdown 지원 추가) -->
              <div
                id="explanation_{{ question.id }}"
                class="explanation-display-box hidden"
              >
                <div class="explanation-display-title">
                  <i class="fas fa-info-circle"></i> 해설
                </div>
                <div class="explanation-display-content markdown-content">
                  {{ question.comment|markdown }}
                </div>
              </div>

              <!-- 이미지 표시 박스 -->
              {% if question.comment_image %}
              <div
                id="image_{{ question.id }}"
                class="image-display-box hidden"
              >
                <div class="image-display-title">
                  <i class="fas fa-image"></i> 관련 이미지
                </div>
                <img
                  src="{{ question.comment_image.url }}"
                  alt="Explanation Image"
                  class="img-fluid rounded"
                />
              </div>
              {% endif %}

              <!-- 새로 추가: 해설 동영상 표시 박스 -->
              {% if question.get_comment_youtube_embed_id %}
              <div
                id="video_explanation_{{ question.id }}"
                class="video-explanation-box hidden"
              >
                <div class="video-explanation-title">
                  <i class="fas fa-video"></i> 해설 동영상
                </div>
                <div
                  class="video-container"
                  style="
                    position: relative;
                    width: 100%;
                    height: 0;
                    padding-bottom: 56.25%;
                    margin: 15px 0;
                  "
                >
                  <iframe
                    id="comment_youtube_{{ question.id }}"
                    src="https://www.youtube.com/embed/{{ question.get_comment_youtube_embed_id }}?enablejsapi=1&rel=0&origin={{ request.scheme }}://{{ request.get_host }}"
                    frameborder="0"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                    referrerpolicy="strict-origin-when-cross-origin"
                    allowfullscreen
                    style="
                      position: absolute;
                      top: 0;
                      left: 0;
                      width: 100%;
                      height: 100%;
                      border-radius: 8px;
                    "
                  ></iframe>
                </div>
                <div
                  class="video-controls"
                  style="text-align: center; margin-top: 10px"
                >
                  <button
                    type="button"
                    class="btn-action-glass"
                    onclick="playCommentYouTube('{{ question.id }}')"
                  >
                    <i class="fas fa-play"></i> 재생
                  </button>
                  <button
                    type="button"
                    class="btn-action-glass"
                    onclick="pauseCommentYouTube('{{ question.id }}')"
                  >
                    <i class="fas fa-pause"></i> 일시정지
                  </button>
                  <button
                    type="button"
                    class="btn-action-glass"
                    onclick="stopCommentYouTube('{{ question.id }}')"
                  >
                    <i class="fas fa-stop"></i> 정지
                  </button>
                </div>
              </div>
              {% endif %}
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </form>
  </div>
</div>

<!-- Floating panel: Temporary Bookmarks -->
<div id="tempBookmarkPanel" class="temp-bookmark-panel">
  <div class="panel-header">
    <span><i class="fas fa-thumbtack"></i> Temp Bookmarks</span>
    <div class="panel-actions">
      <button type="button" class="btn btn-sm btn-outline-secondary" id="togglePanelBtn">
        <i class="fas fa-chevron-down" id="togglePanelIcon"></i>
        <span class="btn-text">Minimize</span>
      </button>
      <button type="button" class="btn btn-sm btn-outline-danger" id="clearTempBookmarksBtn">
        <i class="fas fa-trash-alt"></i>
        <span class="btn-text">Clear</span>
      </button>
    </div>
  </div>
  <div class="panel-body">
    <div id="tempBookmarkList" class="bookmark-list"></div>
  </div>
  <div class="panel-footer small text-muted">Click to jump to question</div>
  <button type="button" class="panel-fab btn btn-primary" id="openPanelFab" title="Open temp bookmarks">
    <i class="fas fa-thumbtack"></i>
  </button>
 </div>

<script>
  // Temporary bookmark (session-only) logic
  (function () {
    const panel = document.getElementById('tempBookmarkPanel');
    if (!panel) return;
    const listEl = document.getElementById('tempBookmarkList');
    const btnHide = document.getElementById('togglePanelBtn');
    const btnClear = document.getElementById('clearTempBookmarksBtn');
    const NAV_HEIGHT = (document.getElementById('mainNavbar')?.offsetHeight || 64) + 12;
    const STORAGE_KEY = 'tempBookmarks_category_{{ category_name|slugify }}';

    function loadTemp() { try { return JSON.parse(sessionStorage.getItem(STORAGE_KEY) || '{}'); } catch (e) { return {}; } }
    function saveTemp(state) { sessionStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

    let temp = loadTemp(); // { [qid]: index }

    function updateButtons() {
      document.querySelectorAll('.temp-bookmark-button').forEach(function (btn) {
        const qid = btn.getAttribute('data-question-id');
        if (qid && temp[qid]) btn.classList.add('active'); else btn.classList.remove('active');
      });
    }

    function scrollToQuestion(qid) {
      const el = document.getElementById('q_' + qid);
      if (!el) return;
      const y = el.getBoundingClientRect().top + window.pageYOffset - NAV_HEIGHT;
      window.scrollTo({ top: y, behavior: 'smooth' });
    }

    function renderList() {
      const entries = Object.entries(temp).map(function (pair) { return { qid: pair[0], idx: parseInt(pair[1], 10) || 0 }; });
      entries.sort(function (a, b) { return a.idx - b.idx; });
      listEl.innerHTML = '';
      if (entries.length === 0) {
        listEl.innerHTML = '<div class="text-muted small">비어 있습니다</div>';
        return;
      }
      entries.forEach(function (item) {
        const a = document.createElement('a');
        a.className = 'bookmark-chip';
        a.href = '#';
        a.textContent = String(item.idx);
        a.title = '문제 #' + item.idx;
        a.addEventListener('click', function (ev) { ev.preventDefault(); scrollToQuestion(item.qid); });
        listEl.appendChild(a);
      });
    }

    window.toggleTempBookmark = function (qid, index) {
      const key = String(qid);
      if (temp[key]) delete temp[key]; else temp[key] = index;
      saveTemp(temp);
      updateButtons();
      renderList();
    };

    if (btnHide) btnHide.addEventListener('click', function () {
      const icon = document.getElementById('togglePanelIcon');
      const textSpan = this.querySelector('.btn-text');
      if (panel.classList.contains('collapsed')) {
        panel.classList.remove('collapsed');
        if (icon) icon.className = 'fas fa-chevron-down';
        if (textSpan) textSpan.textContent = 'Minimize';
      } else {
        panel.classList.add('collapsed');
        if (icon) icon.className = 'fas fa-chevron-up';
        if (textSpan) textSpan.textContent = 'Expand';
      }
    });
    if (btnClear) btnClear.addEventListener('click', function () {
      if (!confirm('임시 북마크를 모두 삭제하시겠어요?')) return;
      temp = {}; saveTemp(temp); updateButtons(); renderList();
    });

    // Initialize state on load
    updateButtons();
    renderList();

    // Expose cleaner for endExam
    window.__clearTempBookmarks = function() { sessionStorage.removeItem(STORAGE_KEY); };
  })();
</script>

<!-- YouTube API 로드 -->
<script src="https://www.youtube.com/iframe_api"></script>

<script>
  let timerInterval;
  let timeRemaining;
  let isPaused = false;
  let youtubePlayers = {}; // YouTube 플레이어들을 저장할 객체

  function sendCommandToIframe(iframeId, command, args = []) {
    const iframe = document.getElementById(iframeId);
    if (!iframe || !iframe.contentWindow) {
      return false;
    }
    iframe.contentWindow.postMessage(
      JSON.stringify({ event: "command", func: command, args: args }),
      "*"
    );
    return true;
  }

  // YouTube API 준비 완료 콜백
  function onYouTubeIframeAPIReady() {
    // 모든 YouTube iframe을 플레이어로 초기화
    {% for question in questions %}
      {% if question.get_youtube_embed_id %}
        youtubePlayers['youtube_{{ question.id }}'] = new YT.Player('youtube_{{ question.id }}', {
          events: {
            onReady: function (event) {
              youtubePlayers['youtube_{{ question.id }}'] = event.target;
            },
          },
        });
      {% endif %}
      {% if question.get_comment_youtube_embed_id %}
        youtubePlayers['comment_youtube_{{ question.id }}'] = new YT.Player('comment_youtube_{{ question.id }}', {
          events: {
            onReady: function (event) {
              youtubePlayers['comment_youtube_{{ question.id }}'] = event.target;
            },
          },
        });
      {% endif %}
    {% endfor %}
  }

  // YouTube 동영상 제어 함수들
  function playYouTube(questionId) {
    const player = youtubePlayers['youtube_' + questionId];
    if (player && typeof player.playVideo === "function") {
      player.playVideo();
    } else {
      sendCommandToIframe('youtube_' + questionId, 'playVideo');
    }
  }

  function pauseYouTube(questionId) {
    const player = youtubePlayers['youtube_' + questionId];
    if (player && typeof player.pauseVideo === "function") {
      player.pauseVideo();
    } else {
      sendCommandToIframe('youtube_' + questionId, 'pauseVideo');
    }
  }

  function stopYouTube(questionId) {
    const player = youtubePlayers['youtube_' + questionId];
    if (player && typeof player.stopVideo === "function") {
      player.stopVideo();
    } else if (sendCommandToIframe('youtube_' + questionId, 'stopVideo')) {
      sendCommandToIframe('youtube_' + questionId, 'seekTo', [0, true]);
    }
  }

  function playCommentYouTube(questionId) {
    const player = youtubePlayers['comment_youtube_' + questionId];
    if (player && typeof player.playVideo === "function") {
      player.playVideo();
    } else {
      sendCommandToIframe('comment_youtube_' + questionId, 'playVideo');
    }
  }

  function pauseCommentYouTube(questionId) {
    const player = youtubePlayers['comment_youtube_' + questionId];
    if (player && typeof player.pauseVideo === "function") {
      player.pauseVideo();
    } else {
      sendCommandToIframe('comment_youtube_' + questionId, 'pauseVideo');
    }
  }

  function stopCommentYouTube(questionId) {
    const player = youtubePlayers['comment_youtube_' + questionId];
    if (player && typeof player.stopVideo === "function") {
      player.stopVideo();
    } else if (sendCommandToIframe('comment_youtube_' + questionId, 'stopVideo')) {
      sendCommandToIframe('comment_youtube_' + questionId, 'seekTo', [0, true]);
    }
  }

  // 타이머 드래그 기능 함수
  function makeDraggable(element) {
    let offsetX, offsetY;

    function onMouseDown(e) {
      if (e.target.closest('.fixed-timer-end-btn')) {
        return;
      }
      e.preventDefault();
      element.classList.add('dragging');

      offsetX = e.clientX - element.offsetLeft;
      offsetY = e.clientY - element.offsetTop;

      element.style.right = 'auto';

      document.addEventListener('mousemove', onMouseMove);
      document.addEventListener('mouseup', onMouseUp, { once: true });
    }

    function onMouseMove(e) {
      const newLeft = e.clientX - offsetX;
      const newTop = e.clientY - offsetY;
      element.style.left = `${newLeft}px`;
      element.style.top = `${newTop}px`;
    }

    function onMouseUp() {
      element.classList.remove('dragging');
      document.removeEventListener('mousemove', onMouseMove);
    }

    element.addEventListener('mousedown', onMouseDown);
  }

  function startTimer(duration) {
    if (timerInterval) clearInterval(timerInterval);

    isPaused = false;
    timeRemaining = duration * 60;
    document.getElementById("start-exam-btn").style.display = "none";
    document.getElementById("pause-exam-btn").style.display = "inline-block";
    document.getElementById("resume-exam-btn").style.display = "none";
    document.getElementById("end-exam-btn").style.display = "inline-block";
    document.getElementById("set-timer-input").disabled = true;

    let fixedTimer = document.querySelector(".fixed-timer");
    if (!fixedTimer) {
      fixedTimer = document.createElement("div");
      fixedTimer.className = "fixed-timer";
      // 인라인 스타일로 직접 적용하여 CSS 충돌 방지
      fixedTimer.style.cssText = `
        position: fixed;
        top: 100px;
        left: 24px;
        right: auto;
        z-index: 1050;
        background: linear-gradient(145deg, rgba(15, 23, 42, 0.95), rgba(30, 41, 59, 0.9));
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 20px;
        padding: 0.75rem 1rem;
        box-shadow: 0 12px 35px rgba(0, 0, 0, 0.4);
        display: inline-flex;
        align-items: center;
        gap: 0.75rem;
        cursor: move;
        user-select: none;
        width: auto;
        max-width: fit-content;
      `;
      fixedTimer.innerHTML = `
        <div id="fixed-timer-display" style="
          font-size: 1.5rem;
          font-weight: 700;
          font-variant-numeric: tabular-nums;
          color: #fff;
          text-shadow: 0 2px 8px rgba(145, 234, 228, 0.5);
          letter-spacing: 0.08em;
          margin: 0;
          padding: 0;
          white-space: nowrap;
        ">00:00</div>
        <button id="fixed-pause-btn" onclick="pauseTimer()" title="일시 정지" style="
          width: 36px;
          height: 36px;
          min-width: 36px;
          border-radius: 10px;
          border: none;
          background: rgba(255, 193, 7, 0.2);
          color: #ffc107;
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
          transition: all 0.2s ease;
          flex-shrink: 0;
          font-size: 0.9rem;
        ">
          <i class="fas fa-pause"></i>
        </button>
        <button id="fixed-resume-btn" onclick="resumeTimer()" title="재시작" style="
          width: 36px;
          height: 36px;
          min-width: 36px;
          border-radius: 10px;
          border: none;
          background: rgba(76, 175, 80, 0.2);
          color: #4caf50;
          cursor: pointer;
          display: none;
          align-items: center;
          justify-content: center;
          transition: all 0.2s ease;
          flex-shrink: 0;
          font-size: 0.9rem;
        ">
          <i class="fas fa-play"></i>
        </button>
        <button class="fixed-timer-end-btn" onclick="endExamWithConfirmation()" title="시험 종료" style="
          width: 36px;
          height: 36px;
          min-width: 36px;
          border-radius: 10px;
          border: none;
          background: rgba(255, 99, 132, 0.2);
          color: #ff6384;
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
          transition: all 0.2s ease;
          flex-shrink: 0;
          font-size: 0.9rem;
        ">
          <i class="fas fa-power-off"></i>
        </button>
      `;
      document.body.appendChild(fixedTimer);
      makeDraggable(fixedTimer);
    }

    timerInterval = setInterval(() => {
      if (timeRemaining <= 0) {
        clearInterval(timerInterval);
        endExam();
        return;
      }
      timeRemaining--;
      const minutes = Math.floor(timeRemaining / 60);
      const seconds = timeRemaining % 60;
      const displayTime = `${minutes.toString().padStart(2, "0")}:${seconds
        .toString()
        .padStart(2, "0")}`;

      document.getElementById("timer-display").textContent = displayTime;
      const fixedTimerDisplay = document.getElementById("fixed-timer-display");
      if (fixedTimerDisplay) {
        fixedTimerDisplay.textContent = displayTime;
      }

      const currentFixedTimer = document.querySelector(".fixed-timer");
      if (timeRemaining <= 300 && currentFixedTimer) {
        currentFixedTimer.style.background = "linear-gradient(135deg, #ff6b6b, #ff4757)";
      }
    }, 1000);
  }

  function pauseTimer() {
    if (isPaused) return;
    isPaused = true;
    clearInterval(timerInterval);
    
    document.getElementById("pause-exam-btn").style.display = "none";
    document.getElementById("resume-exam-btn").style.display = "inline-block";
    
    const fixedPauseBtn = document.getElementById("fixed-pause-btn");
    const fixedResumeBtn = document.getElementById("fixed-resume-btn");
    if (fixedPauseBtn) fixedPauseBtn.style.display = "none";
    if (fixedResumeBtn) fixedResumeBtn.style.display = "flex";
  }

  function resumeTimer() {
    if (!isPaused) return;
    isPaused = false;
    
    document.getElementById("pause-exam-btn").style.display = "inline-block";
    document.getElementById("resume-exam-btn").style.display = "none";
    
    const fixedPauseBtn = document.getElementById("fixed-pause-btn");
    const fixedResumeBtn = document.getElementById("fixed-resume-btn");
    if (fixedPauseBtn) fixedPauseBtn.style.display = "flex";
    if (fixedResumeBtn) fixedResumeBtn.style.display = "none";
    
    timerInterval = setInterval(() => {
      if (timeRemaining <= 0) {
        clearInterval(timerInterval);
        endExam();
        return;
      }
      timeRemaining--;
      const minutes = Math.floor(timeRemaining / 60);
      const seconds = timeRemaining % 60;
      const displayTime = `${minutes.toString().padStart(2, "0")}:${seconds
        .toString()
        .padStart(2, "0")}`;

      document.getElementById("timer-display").textContent = displayTime;
      const fixedTimerDisplay = document.getElementById("fixed-timer-display");
      if (fixedTimerDisplay) {
        fixedTimerDisplay.textContent = displayTime;
      }

      const currentFixedTimer = document.querySelector(".fixed-timer");
      if (timeRemaining <= 300 && currentFixedTimer) {
        currentFixedTimer.style.background = "linear-gradient(135deg, #ff6b6b, #ff4757)";
      }
    }, 1000);
  }

  function endExamWithConfirmation() {
    if (confirm("정말로 시험을 종료하시겠습니까?")) {
      endExam();
    }
  }

  function endExam() {
    clearInterval(timerInterval);
    const fixedTimer = document.querySelector(".fixed-timer");
    if (fixedTimer) fixedTimer.remove();

    // Clear temp bookmarks
    if (typeof window.__clearTempBookmarks === 'function') {
      window.__clearTempBookmarks();
    }

    // 모든 YouTube 동영상 정지
    Object.values(youtubePlayers).forEach(player => {
      if (player && typeof player.stopVideo === "function") {
        player.stopVideo();
      }
    });

    const loadingOverlay = document.getElementById("loadingOverlay");
    loadingOverlay.classList.remove("hidden");
    loadingOverlay.style.display = "flex";

    const questionBlocks = document.querySelectorAll(".question-card");
    let numCorrect = 0, numIncorrect = 0, numUnanswered = 0, numNoanswer = 0;
    let detailedResults = [];

    questionBlocks.forEach((block) => {
      const questionText = block.querySelector(".question-text").textContent.trim();
      const correctOption = block.dataset.correctOption;
      const selectedRadio = block.querySelector('input[type="radio"]:checked');
      let resultType;

      if (!correctOption || correctOption.trim() === "" || correctOption === "default") {
        numNoanswer++;
        resultType = "noanswer";
      } else if (!selectedRadio) {
        numUnanswered++;
        resultType = "unanswered";
      } else if (selectedRadio.value === correctOption) {
        numCorrect++;
        resultType = "correct";
      } else {
        numIncorrect++;
        resultType = "incorrect";
      }
      detailedResults.push({
        question: questionText,
        selected_answer: selectedRadio ? selectedRadio.value : "",
        correct_answer: correctOption || "",
        result: resultType,
      });
    });

    const resultData = {
      category_name: "{{ category_name }}",
      num_correct: numCorrect,
      num_incorrect: numIncorrect,
      num_unanswered: numUnanswered,
      num_noanswer: numNoanswer,
      detailed_results: detailedResults,
    };

    const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;

    fetch("/exam/save_exam_results/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": csrfToken,
      },
      body: JSON.stringify(resultData),
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.status === "ok") {
          window.location.href = `/exam/exam_results/?result_id=${data.result_id}`;
        } else {
          loadingOverlay.classList.add("hidden");
          loadingOverlay.style.display = "none";
          alert("오류가 발생했습니다. 다시 시도해 주세요.");
        }
      })
      .catch((error) => {
        loadingOverlay.classList.add("hidden");
        loadingOverlay.style.display = "none";
        console.error("Error:", error);
        alert("오류가 발생했습니다. 다시 시도해 주세요.");
      });
  }

  document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("start-exam-btn").addEventListener("click", () => {
      const duration = parseInt(document.getElementById("set-timer-input").value, 10);
      if (!isNaN(duration) && duration > 0) {
        startTimer(duration);
      } else {
        alert("올바른 시간을 입력해주세요.");
      }
    });
    document.getElementById("pause-exam-btn").addEventListener("click", pauseTimer);
    document.getElementById("resume-exam-btn").addEventListener("click", resumeTimer);
    document.getElementById("end-exam-btn").addEventListener("click", endExamWithConfirmation);
  });

  function toggleDisplay(id) {
    const element = document.getElementById(id);
    if (element) {
      element.classList.toggle("hidden");
      
      // KaTeX 수식 렌더링 (해설 박스가 표시될 때)
      if (!element.classList.contains("hidden") && !element.dataset.katexRendered) {
        if (typeof renderMathInElement === 'function') {
          renderMathInElement(element, {
            delimiters: [
              {left: '$$', right: '$$', display: true},
              {left: '$', right: '$', display: false},
              {left: '\\(', right: '\\)', display: false},
              {left: '\\[', right: '\\]', display: true}
            ],
            throwOnError: false
          });
          element.dataset.katexRendered = 'true';
        }
      }
    }
  }

  function toggleBookmark(questionId, button) {
    const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
    fetch(`/exam/bookmark/${questionId}/`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": csrfToken,
      },
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.status === "ok") {
          button.classList.toggle("bookmarked", data.is_bookmarked);
        } else {
          alert("오류가 발생했습니다. 다시 시도해 주세요.");
        }
      })
      .catch((error) => {
        console.error("Error:", error);
        alert("오류가 발생했습니다. 다시 시도해 주세요.");
      });
  }
</script>
{% endblock %}
