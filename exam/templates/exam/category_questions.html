{% extends 'base.html' %} {% block page_content %}
<!-- 로딩 오버레이 -->
<div
  id="loadingOverlay"
  class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
  style="
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.5);
    display: none; /* 초기에는 숨김 */
    align-items: center;
    justify-content: center;
    z-index: 1050;
  "
>
  <div class="bg-white p-6 rounded-lg shadow-xl text-center">
    <div
      class="animate-spin rounded-full h-12 w-12 border-4 border-blue-500 border-t-transparent mx-auto"
      style="
        animation: spin 1s linear infinite;
        border-radius: 50%;
        width: 3rem;
        height: 3rem;
        border-width: 4px;
        border-color: #3b82f6;
        border-top-color: transparent;
        margin: auto;
      "
    ></div>
    <p class="mt-4 text-gray-700 font-medium">결과를 불러오는 중입니다...</p>
  </div>
</div>

<!-- Hero Section -->
<div
  class="hero-section position-relative d-flex flex-column justify-content-center align-items-center"
>
  <div class="hero-overlay"></div>
  <div class="hero-content text-center">
    <h1 class="hero-title animate-fade-in">{{ category_name }}</h1>
    <p class="hero-subtitle animate-fade-in-delayed">
      엄선된 문제들로 당신의 실력을 확인해보세요.
    </p>
    <div class="timer-controls animate-fade-in-delayed">
      <div class="timer-input-group">
        <input
          type="number"
          id="set-timer-input"
          class="form-control"
          min="1"
          value="60"
          placeholder="분"
        />
        <button id="start-exam-btn" class="btn-hero">시험 시작</button>
        <!-- 시험 종료 버튼에 새로운 glass 스타일 적용 -->
        <button id="end-exam-btn" class="btn-action-glass danger" style="display: none">
          <i class="fas fa-stop-circle"></i> 시험 종료
        </button>
      </div>
      <div id="timer-display" class="timer-display">00:00</div>
    </div>
  </div>
  <div class="hero-wave">
    <svg viewBox="0 0 1440 320" preserveAspectRatio="none">
      <path
        fill="currentColor"
        d="M0,96L48,112C96,128,192,160,288,186.7C384,213,480,235,576,213.3C672,192,768,128,864,128C960,128,1056,192,1152,208C1248,224,1344,192,1392,176L1440,160L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"
      ></path>
    </svg>
  </div>
</div>

<!-- Questions Section -->
<div class="questions-section questions-left-align">
  <div class="container">
    <form id="exam-form" method="POST">
      {% csrf_token %}
      <div class="row g-4">
        {% for question in questions %}
        <div class="col-12">
          <div
            class="question-card animate-fade-in"
            data-correct-option="{{ question.correct_option }}"
          >
            <!-- 북마크 버튼 -->
            <div
              class="bookmark-button {% if question.is_bookmarked %}bookmarked{% endif %}"
              data-question-id="{{ question.id }}"
              onclick="toggleBookmark({{ question.id }}, this)"
            >
              <i class="fas fa-star"></i>
            </div>

            <div class="question-content">
              <!-- 카테고리 표시 -->
              {% if question.category %}
              <div class="question-category-box">
                <i class="fas fa-tags"></i>
                <span>{{ question.category.name }}</span>
              </div>
              {% endif %}

              <!-- 시험 제목 표시 -->
              {% if question.exam %}
              <div class="question-exam-box">
                <i class="fas fa-file-alt"></i>
                <span>{{ question.exam.title }}</span>
              </div>
              {% endif %}

              <div class="question-text">{{ question.question_text|safe }}</div>

              {% if question.image %}
              <div class="question-image">
                <img
                  src="{{ question.image.url }}"
                  alt="Question Image"
                  class="img-fluid"
                />
              </div>
              {% endif %}

              <div class="options-grid">
                <div class="form-check">
                  <input
                    type="radio"
                    id="option1_{{ question.id }}"
                    name="question_{{ question.id }}"
                    value="{{ question.option1 }}"
                    class="form-check-input"
                  />
                  <label
                    for="option1_{{ question.id }}"
                    class="form-check-label"
                    >{{ question.option1 }}</label
                  >
                </div>
                <div class="form-check">
                  <input
                    type="radio"
                    id="option2_{{ question.id }}"
                    name="question_{{ question.id }}"
                    value="{{ question.option2 }}"
                    class="form-check-input"
                  />
                  <label
                    for="option2_{{ question.id }}"
                    class="form-check-label"
                    >{{ question.option2 }}</label
                  >
                </div>
                <div class="form-check">
                  <input
                    type="radio"
                    id="option3_{{ question.id }}"
                    name="question_{{ question.id }}"
                    value="{{ question.option3 }}"
                    class="form-check-input"
                  />
                  <label
                    for="option3_{{ question.id }}"
                    class="form-check-label"
                    >{{ question.option3 }}</label
                  >
                </div>
                <div class="form-check">
                  <input
                    type="radio"
                    id="option4_{{ question.id }}"
                    name="question_{{ question.id }}"
                    value="{{ question.option4 }}"
                    class="form-check-input"
                  />
                  <label
                    for="option4_{{ question.id }}"
                    class="form-check-label"
                    >{{ question.option4 }}</label
                  >
                </div>
                {% if question.option5 %}
                <div class="form-check">
                  <input
                    type="radio"
                    id="option5_{{ question.id }}"
                    name="question_{{ question.id }}"
                    value="{{ question.option5 }}"
                    class="form-check-input"
                  />
                  <label
                    for="option5_{{ question.id }}"
                    class="form-check-label"
                    >{{ question.option5 }}</label
                  >
                </div>
                {% endif %}
              </div>

              <!-- Action Buttons (새로운 스타일 적용) -->
              <div class="action-buttons">
                <button
                  type="button"
                  class="btn-action-glass"
                  onclick="toggleDisplay('answer_{{ question.id }}')"
                >
                  <i class="fas fa-check-circle"></i> 정답 보기
                </button>
                <button
                  type="button"
                  class="btn-action-glass"
                  onclick="toggleDisplay('explanation_{{ question.id }}')"
                >
                  <i class="fas fa-info-circle"></i> 해설 보기
                </button>
                {% if question.comment_image %}
                <button
                  type="button"
                  class="btn-action-glass"
                  onclick="toggleDisplay('image_{{ question.id }}')"
                >
                  <i class="fas fa-image"></i> 이미지 보기
                </button>
                {% endif %}
              </div>

              <!-- 정답 표시 박스 -->
              <div
                id="answer_{{ question.id }}"
                class="answer-display-box hidden"
              >
                <div class="answer-display-title">
                  <i class="fas fa-check-circle"></i> 정답
                </div>
                <div class="answer-display-content">
                  {{ question.correct_option }}
                </div>
              </div>

              <!-- 해설 표시 박스 -->
              <div
                id="explanation_{{ question.id }}"
                class="explanation-display-box hidden"
              >
                <div class="explanation-display-title">
                  <i class="fas fa-info-circle"></i> 해설
                </div>
                <div class="explanation-display-content">
                  {{ question.comment|safe }}
                </div>
              </div>

              <!-- 이미지 표시 박스 -->
              {% if question.comment_image %}
              <div
                id="image_{{ question.id }}"
                class="image-display-box hidden"
              >
                <div class="image-display-title">
                  <i class="fas fa-image"></i> 관련 이미지
                </div>
                <img
                  src="{{ question.comment_image.url }}"
                  alt="Explanation Image"
                  class="img-fluid rounded"
                />
              </div>
              {% endif %}
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </form>
  </div>
</div>

<script>
  let timerInterval;
  let timeRemaining;

  // --- 타이머 드래그 기능 함수 (새로 추가) ---
  function makeDraggable(element) {
    let offsetX, offsetY;

    function onMouseDown(e) {
      // 종료 버튼을 클릭한 경우에는 드래그를 시작하지 않음
      if (e.target.closest('.fixed-timer-end-btn')) {
        return;
      }
      e.preventDefault();
      element.classList.add('dragging');

      offsetX = e.clientX - element.offsetLeft;
      offsetY = e.clientY - element.offsetTop;
      
      // left 속성을 사용하기 위해 right 속성을 비활성화
      element.style.right = 'auto';

      document.addEventListener('mousemove', onMouseMove);
      document.addEventListener('mouseup', onMouseUp, { once: true });
    }

    function onMouseMove(e) {
      const newLeft = e.clientX - offsetX;
      const newTop = e.clientY - offsetY;
      element.style.left = `${newLeft}px`;
      element.style.top = `${newTop}px`;
    }

    function onMouseUp() {
      element.classList.remove('dragging');
      document.removeEventListener('mousemove', onMouseMove);
    }

    element.addEventListener('mousedown', onMouseDown);
  }

  function startTimer(duration) {
    if (timerInterval) clearInterval(timerInterval);

    timeRemaining = duration * 60;
    document.getElementById("start-exam-btn").style.display = "none";
    document.getElementById("end-exam-btn").style.display = "inline-block";
    document.getElementById("set-timer-input").disabled = true;

    let fixedTimer = document.querySelector(".fixed-timer");
    if (!fixedTimer) {
      fixedTimer = document.createElement("div");
      fixedTimer.className = "fixed-timer";
      fixedTimer.innerHTML = `
        <div id="fixed-timer-display" class="timer-display">00:00</div>
        <button class="fixed-timer-end-btn" onclick="endExamWithConfirmation()" title="시험 종료">
          <i class="fas fa-power-off"></i>
        </button>
      `;
      document.body.appendChild(fixedTimer);
      makeDraggable(fixedTimer); // 타이머 생성 후 드래그 기능 활성화
    }

    timerInterval = setInterval(() => {
      if (timeRemaining <= 0) {
        clearInterval(timerInterval);
        endExam();
        return;
      }
      timeRemaining--;
      const minutes = Math.floor(timeRemaining / 60);
      const seconds = timeRemaining % 60;
      const displayTime = `${minutes.toString().padStart(2, "0")}:${seconds
        .toString()
        .padStart(2, "0")}`;

      document.getElementById("timer-display").textContent = displayTime;
      const fixedTimerDisplay = document.getElementById("fixed-timer-display");
      if (fixedTimerDisplay) {
        fixedTimerDisplay.textContent = displayTime;
      }

      const currentFixedTimer = document.querySelector(".fixed-timer");
      if (timeRemaining <= 300 && currentFixedTimer) {
        currentFixedTimer.style.background = "linear-gradient(135deg, #ff6b6b, #ff4757)";
      }
    }, 1000);
  }

  function endExamWithConfirmation() {
    if (confirm("정말로 시험을 종료하시겠습니까?")) {
      endExam();
    }
  }

  function endExam() {
    clearInterval(timerInterval);
    const fixedTimer = document.querySelector(".fixed-timer");
    if (fixedTimer) fixedTimer.remove();

    const loadingOverlay = document.getElementById("loadingOverlay");
    loadingOverlay.classList.remove("hidden");
    loadingOverlay.style.display = "flex";

    const questionBlocks = document.querySelectorAll(".question-card");
    let numCorrect = 0, numIncorrect = 0, numUnanswered = 0, numNoanswer = 0;
    let detailedResults = [];

    questionBlocks.forEach((block) => {
      const questionText = block.querySelector(".question-text").textContent.trim();
      const correctOption = block.dataset.correctOption;
      const selectedRadio = block.querySelector('input[type="radio"]:checked');
      let resultType;

      if (!correctOption || correctOption.trim() === "" || correctOption === "default") {
        numNoanswer++;
        resultType = "noanswer";
      } else if (!selectedRadio) {
        numUnanswered++;
        resultType = "unanswered";
      } else if (selectedRadio.value === correctOption) {
        numCorrect++;
        resultType = "correct";
      } else {
        numIncorrect++;
        resultType = "incorrect";
      }
      detailedResults.push({
        question: questionText,
        selected_answer: selectedRadio ? selectedRadio.value : "",
        correct_answer: correctOption || "",
        result: resultType,
      });
    });

    const resultData = {
      category_name: "{{ category_name }}",
      num_correct: numCorrect,
      num_incorrect: numIncorrect,
      num_unanswered: numUnanswered,
      num_noanswer: numNoanswer,
      detailed_results: detailedResults,
    };

    const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;

    fetch("/exam/save_exam_results/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": csrfToken,
      },
      body: JSON.stringify(resultData),
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.status === "ok") {
          window.location.href = `/exam/exam_results/?result_id=${data.result_id}`;
        } else {
          loadingOverlay.classList.add("hidden");
          loadingOverlay.style.display = "none";
          alert("결과 저장 중 오류가 발생했습니다. 다시 시도해 주세요.");
        }
      })
      .catch((error) => {
        loadingOverlay.classList.add("hidden");
        loadingOverlay.style.display = "none";
        console.error("Error:", error);
        alert("결과 저장 중 오류가 발생했습니다. 다시 시도해 주세요.");
      });
  }

  document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("start-exam-btn").addEventListener("click", () => {
      const duration = parseInt(document.getElementById("set-timer-input").value, 10);
      if (!isNaN(duration) && duration > 0) {
        startTimer(duration);
      } else {
        alert("유효한 시간을 분 단위로 입력해주세요.");
      }
    });
    document.getElementById("end-exam-btn").addEventListener("click", endExamWithConfirmation);
  });

  function toggleDisplay(id) {
    const element = document.getElementById(id);
    if (element) {
      element.classList.toggle("hidden");
    }
  }

  function toggleBookmark(questionId, button) {
    const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
    fetch(`/exam/bookmark/${questionId}/`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": csrfToken,
      },
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.status === "ok") {
          button.classList.toggle("bookmarked", data.is_bookmarked);
        } else {
          alert("북마크 처리 중 오류가 발생했습니다.");
        }
      })
      .catch((error) => {
        console.error("Error:", error);
        alert("북마크 처리 중 오류가 발생했습니다.");
      });
  }
</script>
{% endblock %}