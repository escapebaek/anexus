{% extends 'base.html' %}
{% load static %}

{% block custom_css %}
  <link href="{% static 'css/pages/exam_overall_analytics.css' %}" rel="stylesheet" />
{% endblock %}

{% block page_content %}
<div class="container mt-5">
  <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
    <div>
      <h1 class="mb-1" style="font-weight: 800; color: #2c3e50;">ğŸ“ˆ Overall Analytics</h1>
      <p class="text-muted mb-0">Comprehensive performance insights across all exams</p>
    </div>
    <div>
      <a href="{% url 'my_results' %}" class="btn btn-outline-secondary me-2">
        <i class="fas fa-list"></i> My Results
      </a>
      <a href="{% url 'question_home' %}" class="btn btn-primary">
        <i class="fas fa-arrow-left"></i> Back to Home
      </a>
    </div>
  </div>

  {% if has_data %}
  
  <!-- Dashboard Hero Section -->
  <div class="dashboard-hero">
    <div class="dashboard-hero-content">
      <!-- Score Gauge -->
      <div class="hero-gauge score-gauge-container">
        <div class="score-gauge">
          <svg viewBox="0 0 200 200">
            <circle class="gauge-bg" cx="100" cy="100" r="85"></circle>
            <circle class="gauge-fill" cx="100" cy="100" r="85"
              style="stroke: white; 
                     stroke-dasharray: 534; 
                     stroke-dashoffset: calc(534 - (534 * {{ avg_pct }}) / 100);">
            </circle>
          </svg>
          <div class="gauge-center">
            <div class="gauge-value">{{ avg_pct }}%</div>
            <div class="gauge-grade">
              {{ performance_grade.grade }} Â· {{ performance_grade.label_kr }}
            </div>
          </div>
        </div>
      </div>
      
      <!-- Hero Stats -->
      <div class="hero-stats">
        <div class="hero-title">ì „ì²´ í•™ìŠµ í˜„í™©</div>
        <div class="hero-subtitle">
          {% if improvement_rate > 5 %}
          ğŸš€ ë¹ ë¥¸ ì†ë„ë¡œ ì„±ì¥ ì¤‘ì…ë‹ˆë‹¤! (+{{ improvement_rate }}%)
          {% elif improvement_rate > 0 %}
          ğŸ“ˆ ê¾¸ì¤€íˆ ì‹¤ë ¥ì´ í–¥ìƒë˜ê³  ìˆìŠµë‹ˆë‹¤! (+{{ improvement_rate }}%)
          {% elif improvement_rate < 0 %}
          ğŸ“Š ìµœê·¼ ì„±ì ì´ ë‹¤ì†Œ í•˜ë½í–ˆìŠµë‹ˆë‹¤. ë³µìŠµì´ í•„ìš”í•´ìš”.
          {% else %}
          âš–ï¸ ì•ˆì •ì ì¸ ì„±ì ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.
          {% endif %}
        </div>
        <div class="hero-sub-stats">
          <div class="hero-sub-stat">
            <div class="value">{{ attempts }}</div>
            <div class="label">Total Attempts</div>
          </div>
          <div class="hero-sub-stat">
            <div class="value">{{ best_pct }}%</div>
            <div class="label">Best Score</div>
          </div>
          <div class="hero-sub-stat">
            <div class="value">{{ total_questions }}</div>
            <div class="label">Questions</div>
          </div>
          <div class="hero-sub-stat">
            <div class="value">{{ labels_all|length }}</div>
            <div class="label">Categories</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Target Progress -->
  <div class="target-progress-card">
    <div class="target-header">
      <h5><i class="fas fa-bullseye text-primary"></i> Target Progress ({{ target_gap.target }}%)</h5>
      {% if target_gap.reached %}
      <span class="target-badge reached"><i class="fas fa-check"></i> ëª©í‘œ ë‹¬ì„±!</span>
      {% else %}
      <span class="target-badge">{{ target_gap.gap }}% ë‚¨ìŒ</span>
      {% endif %}
    </div>
    <div class="target-progress-bar">
      <div class="target-progress-fill" style="width: {{ target_gap.progress_pct }}%;">
        <span class="target-progress-text">{{ avg_pct }}%</span>
      </div>
      <div class="target-marker" style="left: calc({{ target_gap.target }}% - 1.5px);" data-label="{{ target_gap.target }}%"></div>
    </div>
  </div>

  <!-- Trend Cards Row -->
  <div class="row g-3 mb-4">
    <div class="col-md-4">
      <div class="trend-card">
        <div class="trend-icon {% if improvement_rate > 0 %}up{% elif improvement_rate < 0 %}down{% else %}stable{% endif %}">
          {% if improvement_rate > 0 %}
          <i class="fas fa-arrow-up"></i>
          {% elif improvement_rate < 0 %}
          <i class="fas fa-arrow-down"></i>
          {% else %}
          <i class="fas fa-minus"></i>
          {% endif %}
        </div>
        <div class="trend-content">
          <div class="trend-label">Improvement Rate</div>
          <div class="trend-value">
            {% if improvement_rate > 0 %}+{% endif %}{{ improvement_rate }}%
          </div>
          <div class="trend-change {% if improvement_rate > 0 %}positive{% elif improvement_rate < 0 %}negative{% endif %}">
            {% if improvement_rate > 0 %}ì„±ì  í–¥ìƒ ì¤‘{% elif improvement_rate < 0 %}í•˜ë½ ì¶”ì„¸{% else %}ì•ˆì •ì {% endif %}
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="trend-card">
        <div class="trend-icon {% if recent_comparison.diff > 0 %}up{% elif recent_comparison.diff < 0 %}down{% else %}stable{% endif %}">
          <i class="fas fa-clock"></i>
        </div>
        <div class="trend-content">
          <div class="trend-label">ìµœê·¼ 3íšŒ í‰ê· </div>
          <div class="trend-value">{{ recent_comparison.recent_avg }}%</div>
          <div class="trend-change {% if recent_comparison.diff > 0 %}positive{% elif recent_comparison.diff < 0 %}negative{% endif %}">
            vs ì „ì²´ í‰ê·  {% if recent_comparison.diff > 0 %}+{% endif %}{{ recent_comparison.diff }}%
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="trend-card">
        <div class="trend-icon stable">
          <i class="fas fa-trophy"></i>
        </div>
        <div class="trend-content">
          <div class="trend-label">Personal Best</div>
          <div class="trend-value">{{ best_pct }}%</div>
          <div class="trend-change">ì—­ëŒ€ ìµœê³  ì ìˆ˜</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Study Recommendation -->
  <div class="recommendation-box {{ study_recommendation.type }}">
    <div class="rec-icon">
      {% if study_recommendation.icon == 'trophy' %}
      ğŸ†
      {% elif study_recommendation.icon == 'star' %}
      â­
      {% elif study_recommendation.icon == 'lightbulb' %}
      ğŸ’¡
      {% else %}
      ğŸ“š
      {% endif %}
    </div>
    <div class="rec-content">
      <h5><i class="fas fa-graduation-cap"></i> í•™ìŠµ ì¶”ì²œ</h5>
      <p>{{ study_recommendation.message }}</p>
      {% if study_recommendation.priority_categories %}
      <div class="rec-action" style="display: flex; flex-wrap: wrap; gap: 8px;">
        {% for cat in study_recommendation.priority_categories %}
        <a href="{% url 'category_questions' cat.name %}" class="btn btn-sm {% if forloop.first %}btn-warning{% else %}btn-outline-warning{% endif %}">
          <i class="fas fa-play"></i> {{ cat.name }} ({{ cat.accuracy }}%)
        </a>
        {% endfor %}
      </div>
      {% elif study_recommendation.priority_category %}
      <div class="rec-action">
        <a href="{% url 'category_questions' study_recommendation.priority_category %}" class="btn btn-sm btn-warning">
          <i class="fas fa-play"></i> {{ study_recommendation.priority_category }} ë¬¸ì œ í’€ê¸°
        </a>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Strengths & Weaknesses -->
  {% if strong_categories or weak_categories %}
  <div class="insights-panel">
    <h5><i class="fas fa-lightbulb text-warning"></i> Performance Insights</h5>
    <div class="insights-grid">
      <!-- Strengths Column -->
      <div class="insight-column strengths">
        <h6><i class="fas fa-check-circle"></i> ê°•ì  ì¹´í…Œê³ ë¦¬ (â‰¥85%)</h6>
        {% if strong_categories %}
          {% for cat in strong_categories %}
          <div class="category-progress-item">
            <div class="category-progress-header">
              <span class="name">{{ cat.name }}</span>
              <span class="accuracy" style="color: #2ecc71;">{{ cat.accuracy }}%</span>
            </div>
            <div class="category-progress-bar">
              <div class="category-progress-fill excellent" style="width: {{ cat.accuracy }}%;"></div>
            </div>
          </div>
          {% endfor %}
        {% else %}
          <p class="text-muted small">85% ì´ìƒì¸ ì¹´í…Œê³ ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
        {% endif %}
      </div>
      
      <!-- Weaknesses Column -->
      <div class="insight-column weaknesses">
        <h6><i class="fas fa-exclamation-triangle"></i> ë³´ì™„ í•„ìš” (<70%)</h6>
        {% if weak_categories %}
          {% for cat in weak_categories %}
          <div class="category-progress-item">
            <div class="category-progress-header">
              <span class="name">{{ cat.name }}</span>
              <span class="accuracy" style="color: #e74c3c;">{{ cat.accuracy }}%</span>
            </div>
            <div class="category-progress-bar">
              <div class="category-progress-fill poor" style="width: {{ cat.accuracy }}%;"></div>
            </div>
          </div>
          {% endfor %}
        {% else %}
          <p class="text-muted small">70% ë¯¸ë§Œì¸ ì¹´í…Œê³ ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤! ğŸ‰</p>
        {% endif %}
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Progress Over Time -->
  <div class="section-header">
    <i class="fas fa-chart-line"></i>
    <h3>Progress Timeline</h3>
  </div>
  <div class="chart-card">
    <h5>Score Trends Across All Attempts</h5>
    <div class="chart-container">
      <canvas id="progressChart"></canvas>
    </div>
  </div>

  <!-- All Exams Combined -->
  <div class="section-header">
    <i class="fas fa-globe"></i>
    <h3>Combined Performance</h3>
  </div>
  <div class="row g-4 mb-4">
    <div class="col-lg-7">
      <div class="chart-card">
        <h5>Category Breakdown (All Exams)</h5>
        <div class="chart-container chart-container-tall">
          <canvas id="allCountsChart"></canvas>
        </div>
      </div>
    </div>
    <div class="col-lg-5">
      <div class="chart-card">
        <h5>Category Accuracy</h5>
        <div class="chart-container chart-container-tall">
          <canvas id="allAccChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Per Exam Analysis -->
  <div class="section-header">
    <i class="fas fa-book-open"></i>
    <h3>Individual Exam Performance</h3>
  </div>
  <div class="chart-card mb-3">
    <div class="row align-items-center">
      <div class="col-md-8">
        <label class="fw-bold mb-2"><i class="fas fa-filter"></i> Select Exam:</label>
        <select id="examSelect" class="form-select">
          {% for ex in exam_cards %}
          <option value="{{ ex.id }}">
            {{ ex.title }} ({{ ex.attempts }} attempts, avg {{ ex.avg_pct }}%, best {{ ex.best_pct }}%)
          </option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-4 text-end mt-3 mt-md-0">
        <a id="examRollupLink" href="#" class="btn btn-outline-info">
          <i class="fas fa-chart-bar"></i> Open Exam Analytics
        </a>
      </div>
    </div>
  </div>
  <div class="row g-4">
    <div class="col-lg-7">
      <div class="chart-card">
        <h5>Category Breakdown</h5>
        <div class="chart-container chart-container-tall">
          <canvas id="examCountsChart"></canvas>
        </div>
      </div>
    </div>
    <div class="col-lg-5">
      <div class="chart-card">
        <h5>Category Accuracy</h5>
        <div class="chart-container chart-container-tall">
          <canvas id="examAccChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  {% else %}
  <div class="text-center py-5">
    <div class="performance-indicator d-inline-flex">
      <div class="performance-icon">
        <i class="fas fa-chart-bar" style="color: #95a5a6;"></i>
      </div>
      <div class="performance-text">
        <h3>No Data Available</h3>
        <p>Take your first exam to see comprehensive analytics and insights</p>
      </div>
    </div>
    <div class="mt-4">
      <a href="{% url 'exam_list' %}" class="btn btn-primary btn-lg">
        <i class="fas fa-play"></i> Browse Exams
      </a>
    </div>
  </div>
  {% endif %}
</div>

{% if has_data %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
<script>
  const labelsAll = {{ labels_all|safe }};
  const correctAll = {{ correct_all|safe }};
  const incorrectAll = {{ incorrect_all|safe }};
  const unansweredAll = {{ unanswered_all|safe }};
  const noanswerAll = {{ noanswer_all|safe }};
  const accAll = {{ acc_all|safe }};

  const progressData = {
    labels: {{ attempt_dates|safe }},
    datasets: [
      {
        label: 'Score (%)',
        data: {{ attempt_scores|safe }},
        borderColor: '#667eea',
        backgroundColor: 'rgba(102, 126, 234, 0.1)',
        tension: 0.4,
        fill: true,
        pointRadius: 6,
        pointHoverRadius: 8,
        pointBackgroundColor: '#667eea',
        pointBorderColor: '#fff',
        pointBorderWidth: 2
      },
      {
        label: 'Moving Average',
        data: {{ moving_avg|safe }},
        borderColor: '#38ef7d',
        borderDash: [5, 5],
        borderWidth: 2,
        pointRadius: 0,
        tension: 0.4
      }
    ]
  };

  const progressCtx = document.getElementById('progressChart');
  if (progressCtx) {
    new Chart(progressCtx, {
      type: 'line',
      data: progressData,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: true, position: 'top' },
          tooltip: {
            mode: 'index',
            intersect: false,
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            padding: 12,
            titleFont: { size: 14 },
            bodyFont: { size: 13 },
            callbacks: {
              label: function(context) {
                return context.dataset.label + ': ' + context.parsed.y + '%';
              }
            }
          },
          annotation: {
            annotations: {
              targetLine: {
                type: 'line',
                yMin: 85,
                yMax: 85,
                borderColor: '#e74c3c',
                borderWidth: 2,
                borderDash: [10, 5],
                label: {
                  display: true,
                  content: 'Target 85%',
                  position: 'end',
                  backgroundColor: '#e74c3c',
                  color: 'white',
                  font: { size: 11, weight: 'bold' }
                }
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            max: 100,
            grid: { color: 'rgba(0, 0, 0, 0.05)' },
            ticks: {
              callback: function(value) { return value + '%'; }
            }
          },
          x: {
            grid: { display: false }
          }
        }
      }
    });
  }

  const allCountsCtx = document.getElementById('allCountsChart');
  if (allCountsCtx) {
    new Chart(allCountsCtx, {
      type: 'bar',
      data: {
        labels: labelsAll,
        datasets: [
          { label: 'Correct', data: correctAll, backgroundColor: '#2ecc71' },
          { label: 'Incorrect', data: incorrectAll, backgroundColor: '#e74c3c' },
          { label: 'Unanswered', data: unansweredAll, backgroundColor: '#f1c40f' },
          { label: 'No Answer', data: noanswerAll, backgroundColor: '#95a5a6' }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { position: 'bottom' } },
        indexAxis: 'y',
        scales: {
          x: { stacked: true, beginAtZero: true, grid: { color: 'rgba(0, 0, 0, 0.05)' } },
          y: { stacked: true, ticks: { autoSkip: false, font: { size: 12 } }, grid: { display: false } }
        }
      }
    });
  }

  const allAccCtx = document.getElementById('allAccChart');
  if (allAccCtx) {
    new Chart(allAccCtx, {
      type: 'bar',
      data: {
        labels: labelsAll,
        datasets: [{
          label: 'Accuracy %',
          data: accAll,
          backgroundColor: accAll.map(function(v) {
            return v >= 85 ? '#2ecc71' : v >= 70 ? '#3498db' : v >= 60 ? '#f39c12' : '#e74c3c';
          }),
          borderRadius: 8
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: function(context) {
                return 'Accuracy: ' + context.parsed.x + '%';
              }
            }
          }
        },
        indexAxis: 'y',
        scales: {
          x: { beginAtZero: true, max: 100, grid: { color: 'rgba(0, 0, 0, 0.05)' } },
          y: { ticks: { autoSkip: false, font: { size: 12 } }, grid: { display: false } }
        }
      }
    });
  }

  const examData = {{ exam_data|safe }};
  const examSelect = document.getElementById('examSelect');
  const examCountsCtx = document.getElementById('examCountsChart');
  const examAccCtx = document.getElementById('examAccChart');
  const rollupLink = document.getElementById('examRollupLink');

  let examCountsChart = null;
  let examAccChart = null;

  function renderExamCharts(examId) {
    const data = examData[String(examId)] || {labels: [], correct: [], incorrect: [], unanswered: [], noanswer: [], accuracy: []};

    if (examCountsChart) examCountsChart.destroy();
    if (examAccChart) examAccChart.destroy();

    if (examCountsCtx) {
      examCountsChart = new Chart(examCountsCtx, {
        type: 'bar',
        data: {
          labels: data.labels,
          datasets: [
            { label: 'Correct', data: data.correct, backgroundColor: '#2ecc71' },
            { label: 'Incorrect', data: data.incorrect, backgroundColor: '#e74c3c' },
            { label: 'Unanswered', data: data.unanswered, backgroundColor: '#f1c40f' },
            { label: 'No Answer', data: data.noanswer, backgroundColor: '#95a5a6' }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: 'bottom' } },
          indexAxis: 'y',
          scales: {
            x: { stacked: true, beginAtZero: true, grid: { color: 'rgba(0, 0, 0, 0.05)' } },
            y: { stacked: true, ticks: { autoSkip: false, font: { size: 12 } }, grid: { display: false } }
          }
        }
      });
    }

    if (examAccCtx) {
      examAccChart = new Chart(examAccCtx, {
        type: 'bar',
        data: {
          labels: data.labels,
          datasets: [{
            label: 'Accuracy %',
            data: data.accuracy,
            backgroundColor: data.accuracy.map(function(v) {
              return v >= 85 ? '#2ecc71' : v >= 70 ? '#3498db' : v >= 60 ? '#f39c12' : '#e74c3c';
            }),
            borderRadius: 8
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return 'Accuracy: ' + context.parsed.x + '%';
                }
              }
            }
          },
          indexAxis: 'y',
          scales: {
            x: { beginAtZero: true, max: 100, grid: { color: 'rgba(0, 0, 0, 0.05)' } },
            y: { ticks: { autoSkip: false, font: { size: 12 } }, grid: { display: false } }
          }
        }
      });
    }
  }

  if (examSelect && examSelect.options.length > 0) {
    renderExamCharts(examSelect.value);

    if (rollupLink) {
      rollupLink.href = `/exam/analytics/exam/${examSelect.value}/`;
    }

    examSelect.addEventListener('change', function() {
      renderExamCharts(this.value);
      if (rollupLink) {
        rollupLink.href = `/exam/analytics/exam/${this.value}/`;
      }
    });
  }
</script>
{% endif %}
{% endblock %}
