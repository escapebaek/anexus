{% extends 'base.html' %}
{% load static %}

{% block custom_css %}
  <link href="{% static 'css/pages/exam_overall_analytics.css' %}" rel="stylesheet" />
{% endblock %}

{% block page_content %}
<div class="container mt-5">
  <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
    <div>
      <h1 class="mb-1" style="font-weight: 800; color: #2c3e50;">Overall Analytics</h1>
      <p class="text-muted mb-0">Comprehensive performance insights across all exams</p>
    </div>
    <div>
      <a href="{% url 'my_results' %}" class="btn btn-outline-secondary me-2">
        <i class="fas fa-list"></i> My Results
      </a>
      <a href="{% url 'question_home' %}" class="btn btn-primary">
        <i class="fas fa-arrow-left"></i> Back to Home
      </a>
    </div>
  </div>

  {% if has_data %}
  <!-- Performance Overview -->
  <div class="performance-indicator">
    <div class="performance-icon">
      {% if avg_pct >= 85 %}
      <i class="fas fa-trophy" style="color: #f39c12;"></i>
      {% elif avg_pct >= 70 %}
      <i class="fas fa-chart-line" style="color: #667eea;"></i>
      {% else %}
      <i class="fas fa-graduation-cap" style="color: #3498db;"></i>
      {% endif %}
    </div>
    <div class="performance-text flex-grow-1">
      <h3>
        {% if avg_pct >= 85 %}
        Outstanding Progress!
        {% elif avg_pct >= 70 %}
        Steady Improvement
        {% else %}
        Building Foundation
        {% endif %}
      </h3>
      <p>
        {% if improvement_rate > 5 %}
        You're improving rapidly by {{ improvement_rate }}% - Excellent work!
        {% elif improvement_rate > 0 %}
        Consistent improvement of {{ improvement_rate }}% - Keep it up!
        {% elif improvement_rate < 0 %}
        Recent performance dip - Consider reviewing weak areas
        {% else %}
        Maintaining stable performance across attempts
        {% endif %}
      </p>
    </div>
  </div>

  <!-- Key Stats -->
  <div class="row g-4 mb-4">
    <div class="col-md-3 col-sm-6">
      <div class="stat-card">
        <div class="stat-label">Total Attempts</div>
        <h2 class="stat-value">{{ attempts }}</h2>
        <span class="stat-change neutral">
          <i class="fas fa-layer-group"></i> All exams
        </span>
      </div>
    </div>
    <div class="col-md-3 col-sm-6">
      <div class="stat-card success">
        <div class="stat-label">Average Score</div>
        <h2 class="stat-value success-grad">{{ avg_pct }}%</h2>
        {% if improvement_rate > 0 %}
        <span class="stat-change positive">
          <i class="fas fa-arrow-up"></i> +{{ improvement_rate }}% trend
        </span>
        {% elif improvement_rate < 0 %}
        <span class="stat-change negative">
          <i class="fas fa-arrow-down"></i> {{ improvement_rate }}% trend
        </span>
        {% else %}
        <span class="stat-change neutral">
          <i class="fas fa-minus"></i> Stable
        </span>
        {% endif %}
      </div>
    </div>
    <div class="col-md-3 col-sm-6">
      <div class="stat-card info">
        <div class="stat-label">Best Score</div>
        <h2 class="stat-value info-grad">{{ best_pct }}%</h2>
        <span class="stat-change positive">
          <i class="fas fa-trophy"></i> Personal record
        </span>
      </div>
    </div>
    <div class="col-md-3 col-sm-6">
      <div class="stat-card danger">
        <div class="stat-label">Categories</div>
        <h2 class="stat-value danger-grad">{{ labels_all|length }}</h2>
        <span class="stat-change neutral">
          <i class="fas fa-folder"></i> Total categories
        </span>
      </div>
    </div>
  </div>

  <!-- Strengths & Weaknesses -->
  {% if strong_categories or weak_categories %}
  <div class="chart-card mb-4">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
      <h5 class="mb-0"><i class="fas fa-lightbulb text-warning"></i> Performance Insights</h5>
      <div>
        {% if strong_categories %}
        <span class="category-badge strong">
          <i class="fas fa-star"></i> {{ strong_categories|length }} Strong
        </span>
        {% endif %}
        {% if weak_categories %}
        <span class="category-badge weak">
          <i class="fas fa-flag"></i> {{ weak_categories|length }} Need Focus
        </span>
        {% endif %}
      </div>
    </div>
    <div class="row mt-3">
      {% if strong_categories %}
      <div class="col-md-6">
        <h6 class="text-success"><i class="fas fa-check-circle"></i> Strong Categories (>=85%)</h6>
        <div class="mt-2">
          {% for cat in strong_categories %}
          <span class="category-badge strong">{{ cat.name }}: {{ cat.accuracy }}%</span>
          {% endfor %}
        </div>
      </div>
      {% endif %}
      {% if weak_categories %}
      <div class="col-md-6">
        <h6 class="text-danger"><i class="fas fa-exclamation-triangle"></i> Areas to Strengthen (<70%)</h6>
        <div class="mt-2">
          {% for cat in weak_categories %}
          <span class="category-badge weak">{{ cat.name }}: {{ cat.accuracy }}%</span>
          {% endfor %}
        </div>
      </div>
      {% endif %}
    </div>
  </div>
  {% endif %}

  <!-- Progress Over Time -->
  <div class="section-header">
    <i class="fas fa-chart-line"></i>
    <h3>Progress Timeline</h3>
  </div>
  <div class="chart-card">
    <h5>Score Trends Across All Attempts</h5>
    <div class="chart-container">
      <canvas id="progressChart"></canvas>
    </div>
  </div>

  <!-- All Exams Combined -->
  <div class="section-header">
    <i class="fas fa-globe"></i>
    <h3>Combined Performance</h3>
  </div>
  <div class="row g-4 mb-4">
    <div class="col-lg-7">
      <div class="chart-card">
        <h5>Category Breakdown (All Exams)</h5>
        <div class="chart-container chart-container-tall">
          <canvas id="allCountsChart"></canvas>
        </div>
      </div>
    </div>
    <div class="col-lg-5">
      <div class="chart-card">
        <h5>Category Accuracy</h5>
        <div class="chart-container chart-container-tall">
          <canvas id="allAccChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Per Exam Analysis -->
  <div class="section-header">
    <i class="fas fa-book-open"></i>
    <h3>Individual Exam Performance</h3>
  </div>
  <div class="chart-card mb-3">
    <div class="row align-items-center">
      <div class="col-md-8">
        <label class="fw-bold mb-2"><i class="fas fa-filter"></i> Select Exam:</label>
        <select id="examSelect" class="form-select">
          {% for ex in exam_cards %}
          <option value="{{ ex.id }}">
            {{ ex.title }} ({{ ex.attempts }} attempts, avg {{ ex.avg_pct }}%, best {{ ex.best_pct }}%)
          </option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-4 text-end mt-3 mt-md-0">
        <a id="examRollupLink" href="#" class="btn btn-outline-info">
          <i class="fas fa-chart-bar"></i> Open Exam Analytics
        </a>
      </div>
    </div>
  </div>
  <div class="row g-4">
    <div class="col-lg-7">
      <div class="chart-card">
        <h5>Category Breakdown</h5>
        <div class="chart-container chart-container-tall">
          <canvas id="examCountsChart"></canvas>
        </div>
      </div>
    </div>
    <div class="col-lg-5">
      <div class="chart-card">
        <h5>Category Accuracy</h5>
        <div class="chart-container chart-container-tall">
          <canvas id="examAccChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  {% else %}
  <div class="text-center py-5">
    <div class="performance-indicator d-inline-flex">
      <div class="performance-icon">
        <i class="fas fa-chart-bar" style="color: #95a5a6;"></i>
      </div>
      <div class="performance-text">
        <h3>No Data Available</h3>
        <p>Take your first exam to see comprehensive analytics and insights</p>
      </div>
    </div>
    <div class="mt-4">
      <a href="{% url 'exam_list' %}" class="btn btn-primary btn-lg">
        <i class="fas fa-play"></i> Browse Exams
      </a>
    </div>
  </div>
  {% endif %}
</div>

{% if has_data %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
  const labelsAll = {{ labels_all|safe }};
  const correctAll = {{ correct_all|safe }};
  const incorrectAll = {{ incorrect_all|safe }};
  const unansweredAll = {{ unanswered_all|safe }};
  const noanswerAll = {{ noanswer_all|safe }};
  const accAll = {{ acc_all|safe }};

  const progressData = {
    labels: {{ attempt_dates|safe }},
    datasets: [
      {
        label: 'Score (%)',
        data: {{ attempt_scores|safe }},
        borderColor: '#667eea',
        backgroundColor: 'rgba(102, 126, 234, 0.1)',
        tension: 0.4,
        fill: true,
        pointRadius: 6,
        pointHoverRadius: 8,
        pointBackgroundColor: '#667eea',
        pointBorderColor: '#fff',
        pointBorderWidth: 2
      },
      {
        label: 'Moving Average',
        data: {{ moving_avg|safe }},
        borderColor: '#38ef7d',
        borderDash: [5, 5],
        borderWidth: 2,
        pointRadius: 0,
        tension: 0.4
      }
    ]
  };

  const progressCtx = document.getElementById('progressChart');
  if (progressCtx) {
    new Chart(progressCtx, {
      type: 'line',
      data: progressData,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: true, position: 'top' },
          tooltip: {
            mode: 'index',
            intersect: false,
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            padding: 12,
            titleFont: { size: 14 },
            bodyFont: { size: 13 },
            callbacks: {
              label: function(context) {
                return context.dataset.label + ': ' + context.parsed.y + '%';
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            max: 100,
            grid: { color: 'rgba(0, 0, 0, 0.05)' },
            ticks: {
              callback: function(value) { return value + '%'; }
            }
          },
          x: {
            grid: { display: false }
          }
        }
      }
    });
  }

  const allCountsCtx = document.getElementById('allCountsChart');
  if (allCountsCtx) {
    new Chart(allCountsCtx, {
      type: 'bar',
      data: {
        labels: labelsAll,
        datasets: [
          { label: 'Correct', data: correctAll, backgroundColor: '#2ecc71' },
          { label: 'Incorrect', data: incorrectAll, backgroundColor: '#e74c3c' },
          { label: 'Unanswered', data: unansweredAll, backgroundColor: '#f1c40f' },
          { label: 'No Answer', data: noanswerAll, backgroundColor: '#95a5a6' }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { position: 'bottom' } },
        indexAxis: 'y',
        scales: {
          x: { stacked: true, beginAtZero: true, grid: { color: 'rgba(0, 0, 0, 0.05)' } },
          y: { stacked: true, ticks: { autoSkip: false, font: { size: 12 } }, grid: { display: false } }
        }
      }
    });
  }

  const allAccCtx = document.getElementById('allAccChart');
  if (allAccCtx) {
    new Chart(allAccCtx, {
      type: 'bar',
      data: {
        labels: labelsAll,
        datasets: [{
          label: 'Accuracy %',
          data: accAll,
          backgroundColor: accAll.map(function(v) {
            return v >= 85 ? '#2ecc71' : v >= 70 ? '#3498db' : v >= 60 ? '#f39c12' : '#e74c3c';
          }),
          borderRadius: 8
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: function(context) {
                return 'Accuracy: ' + context.parsed.x + '%';
              }
            }
          }
        },
        indexAxis: 'y',
        scales: {
          x: { beginAtZero: true, max: 100, grid: { color: 'rgba(0, 0, 0, 0.05)' } },
          y: { ticks: { autoSkip: false, font: { size: 12 } }, grid: { display: false } }
        }
      }
    });
  }

  const examData = {{ exam_data|safe }};
  const examSelect = document.getElementById('examSelect');
  const examCountsCtx = document.getElementById('examCountsChart');
  const examAccCtx = document.getElementById('examAccChart');
  const rollupLink = document.getElementById('examRollupLink');

  let examCountsChart = null;
  let examAccChart = null;

  function renderExamCharts(examId) {
    const data = examData[String(examId)] || {labels: [], correct: [], incorrect: [], unanswered: [], noanswer: [], accuracy: []};

    if (examCountsChart) examCountsChart.destroy();
    if (examAccChart) examAccChart.destroy();

    if (examCountsCtx) {
      examCountsChart = new Chart(examCountsCtx, {
        type: 'bar',
        data: {
          labels: data.labels,
          datasets: [
            { label: 'Correct', data: data.correct, backgroundColor: '#2ecc71' },
            { label: 'Incorrect', data: data.incorrect, backgroundColor: '#e74c3c' },
            { label: 'Unanswered', data: data.unanswered, backgroundColor: '#f1c40f' },
            { label: 'No Answer', data: data.noanswer, backgroundColor: '#95a5a6' }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: 'bottom' } },
          indexAxis: 'y',
          scales: {
            x: { stacked: true, beginAtZero: true, grid: { color: 'rgba(0, 0, 0, 0.05)' } },
            y: { stacked: true, ticks: { autoSkip: false, font: { size: 12 } }, grid: { display: false } }
          }
        }
      });
    }

    if (examAccCtx) {
      examAccChart = new Chart(examAccCtx, {
        type: 'bar',
        data: {
          labels: data.labels,
          datasets: [{
            label: 'Accuracy %',
            data: data.accuracy,
            backgroundColor: data.accuracy.map(function(v) {
              return v >= 85 ? '#2ecc71' : v >= 70 ? '#3498db' : v >= 60 ? '#f39c12' : '#e74c3c';
            }),
            borderRadius: 8
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return 'Accuracy: ' + context.parsed.x + '%';
                }
              }
            }
          },
          indexAxis: 'y',
          scales: {
            x: { beginAtZero: true, max: 100, grid: { color: 'rgba(0, 0, 0, 0.05)' } },
            y: { ticks: { autoSkip: false, font: { size: 12 } }, grid: { display: false } }
          }
        }
      });
    }
  }

  if (examSelect && examSelect.options.length > 0) {
    renderExamCharts(examSelect.value);

    if (rollupLink) {
      rollupLink.href = `/exam/analytics/exam/${examSelect.value}/`;
    }

    examSelect.addEventListener('change', function() {
      renderExamCharts(this.value);
      if (rollupLink) {
        rollupLink.href = `/exam/analytics/exam/${this.value}/`;
      }
    });
  }
</script>
{% endif %}
{% endblock %}
