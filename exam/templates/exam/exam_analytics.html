{% extends 'base.html' %}
{% load static %}

{% block custom_css %}
<link href="{% static 'css/pages/exam_analytics.css' %}" rel="stylesheet" />
{% endblock %}

{% block page_content %}

<div class="container mt-5">
  <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
    <div>
      <h1 class="mb-1" style="font-weight: 800; color: #2c3e50;">📊 Exam Analytics</h1>
      <p class="text-muted mb-0">{{ exam.title }}</p>
    </div>
    <div>
      <a href="{% url 'my_results' %}" class="btn btn-outline-secondary me-2">
        <i class="fas fa-list"></i> My Results
      </a>
      <a href="{% url 'question_home' %}" class="btn btn-primary">
        <i class="fas fa-arrow-left"></i> Back to Home
      </a>
    </div>
  </div>

  {% if has_data %}
  
  <!-- Dashboard Hero Section with Score Gauge -->
  <div class="dashboard-hero">
    <div class="dashboard-hero-content">
      <!-- Score Gauge -->
      <div class="score-gauge-container">
        <div class="score-gauge">
          <svg viewBox="0 0 180 180">
            <circle class="gauge-bg" cx="90" cy="90" r="75"></circle>
            <circle class="gauge-fill" cx="90" cy="90" r="75"
              style="stroke: {{ performance_grade.color }}; 
                     stroke-dasharray: 471; 
                     stroke-dashoffset: calc(471 - (471 * {{ avg_pct }}) / 100);">
            </circle>
          </svg>
          <div class="gauge-center">
            <div class="gauge-value" style="color: {{ performance_grade.color }};">{{ avg_pct }}%</div>
            <div class="gauge-grade" style="background: {{ performance_grade.color }}; color: white;">
              {{ performance_grade.grade }} · {{ performance_grade.label_kr }}
            </div>
          </div>
        </div>
      </div>
      
      <!-- Hero Stats -->
      <div class="hero-stats">
        <div class="hero-title">Overall Performance</div>
        <div class="hero-sub-stats">
          <div class="hero-sub-stat">
            <div class="value">{{ attempts }}</div>
            <div class="label">Attempts</div>
          </div>
          <div class="hero-sub-stat">
            <div class="value">{{ best_pct }}%</div>
            <div class="label">Best Score</div>
          </div>
          <div class="hero-sub-stat">
            <div class="value">{{ total_questions }}</div>
            <div class="label">Questions</div>
          </div>
          <div class="hero-sub-stat">
            <div class="value">{{ labels|length }}</div>
            <div class="label">Categories</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Target Progress -->
  <div class="target-progress-card">
    <div class="target-header">
      <h5><i class="fas fa-bullseye text-primary"></i> Target Progress ({{ target_gap.target }}%)</h5>
      {% if target_gap.reached %}
      <span class="target-badge reached"><i class="fas fa-check"></i> 목표 달성!</span>
      {% else %}
      <span class="target-badge">{{ target_gap.gap }}% 남음</span>
      {% endif %}
    </div>
    <div class="target-progress-bar">
      <div class="target-progress-fill" style="width: {{ target_gap.progress_pct }}%;">
        <span class="target-progress-text">{{ avg_pct }}%</span>
      </div>
      <div class="target-marker" style="left: calc({{ target_gap.target }}% - 1.5px);" data-label="{{ target_gap.target }}%"></div>
    </div>
  </div>

  <!-- Recent Trend Cards Row -->
  <div class="row g-3 mb-4">
    <div class="col-md-4">
      <div class="trend-card">
        <div class="trend-icon {% if improvement_rate > 0 %}up{% elif improvement_rate < 0 %}down{% else %}stable{% endif %}">
          {% if improvement_rate > 0 %}
          <i class="fas fa-arrow-up"></i>
          {% elif improvement_rate < 0 %}
          <i class="fas fa-arrow-down"></i>
          {% else %}
          <i class="fas fa-minus"></i>
          {% endif %}
        </div>
        <div class="trend-content">
          <div class="trend-label">Improvement Rate</div>
          <div class="trend-value">
            {% if improvement_rate > 0 %}+{% endif %}{{ improvement_rate }}%
          </div>
          <div class="trend-change {% if improvement_rate > 0 %}positive{% elif improvement_rate < 0 %}negative{% endif %}">
            {% if improvement_rate > 0 %}성적 향상 중{% elif improvement_rate < 0 %}하락 추세{% else %}안정적{% endif %}
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="trend-card">
        <div class="trend-icon {% if recent_comparison.diff > 0 %}up{% elif recent_comparison.diff < 0 %}down{% else %}stable{% endif %}">
          <i class="fas fa-clock"></i>
        </div>
        <div class="trend-content">
          <div class="trend-label">Recent 3 Avg</div>
          <div class="trend-value">{{ recent_comparison.recent_avg }}%</div>
          <div class="trend-change {% if recent_comparison.diff > 0 %}positive{% elif recent_comparison.diff < 0 %}negative{% endif %}">
            vs 전체 평균 {% if recent_comparison.diff > 0 %}+{% endif %}{{ recent_comparison.diff }}%
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="trend-card">
        <div class="trend-icon stable">
          <i class="fas fa-trophy"></i>
        </div>
        <div class="trend-content">
          <div class="trend-label">Personal Best</div>
          <div class="trend-value">{{ best_pct }}%</div>
          <div class="trend-change">최고 기록</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Study Recommendation -->
  <div class="recommendation-box {{ study_recommendation.type }}">
    <div class="rec-icon">
      {% if study_recommendation.icon == 'trophy' %}
      🏆
      {% elif study_recommendation.icon == 'star' %}
      ⭐
      {% elif study_recommendation.icon == 'lightbulb' %}
      💡
      {% else %}
      📚
      {% endif %}
    </div>
    <div class="rec-content">
      <h5><i class="fas fa-graduation-cap"></i> 학습 추천</h5>
      <p>{{ study_recommendation.message }}</p>
      {% if study_recommendation.priority_categories %}
      <div class="rec-action" style="display: flex; flex-wrap: wrap; gap: 8px;">
        {% for cat in study_recommendation.priority_categories %}
        <a href="{% url 'category_questions' cat.name %}" class="btn btn-sm {% if forloop.first %}btn-warning{% else %}btn-outline-warning{% endif %}">
          <i class="fas fa-play"></i> {{ cat.name }} ({{ cat.accuracy }}%)
        </a>
        {% endfor %}
      </div>
      {% elif study_recommendation.priority_category %}
      <div class="rec-action">
        <a href="{% url 'category_questions' study_recommendation.priority_category %}" class="btn btn-sm btn-warning">
          <i class="fas fa-play"></i> {{ study_recommendation.priority_category }} 문제 풀기
        </a>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Strengths & Weaknesses Panel -->
  {% if strong_categories or weak_categories %}
  <div class="insights-panel">
    <h5><i class="fas fa-lightbulb text-warning"></i> Performance Insights</h5>
    <div class="insights-grid">
      <!-- Strengths Column -->
      <div class="insight-column strengths">
        <h6><i class="fas fa-check-circle"></i> 강점 카테고리 (≥85%)</h6>
        {% if strong_categories %}
          {% for cat in strong_categories %}
          <div class="category-progress-item">
            <div class="category-progress-header">
              <span class="name">{{ cat.name }}</span>
              <span class="accuracy" style="color: #2ecc71;">{{ cat.accuracy }}%</span>
            </div>
            <div class="category-progress-bar">
              <div class="category-progress-fill excellent" style="width: {{ cat.accuracy }}%;"></div>
            </div>
          </div>
          {% endfor %}
        {% else %}
          <p class="text-muted small">85% 이상인 카테고리가 없습니다.</p>
        {% endif %}
      </div>
      
      <!-- Weaknesses Column -->
      <div class="insight-column weaknesses">
        <h6><i class="fas fa-exclamation-triangle"></i> 보완 필요 (<70%)</h6>
        {% if weak_categories %}
          {% for cat in weak_categories %}
          <div class="category-progress-item">
            <div class="category-progress-header">
              <span class="name">{{ cat.name }}</span>
              <span class="accuracy" style="color: #e74c3c;">{{ cat.accuracy }}%</span>
            </div>
            <div class="category-progress-bar">
              <div class="category-progress-fill poor" style="width: {{ cat.accuracy }}%;"></div>
            </div>
          </div>
          {% endfor %}
        {% else %}
          <p class="text-muted small">70% 미만인 카테고리가 없습니다! 🎉</p>
        {% endif %}
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Progress Over Time -->
  <div class="section-header">
    <i class="fas fa-chart-line"></i>
    <h3>Progress Tracking</h3>
  </div>
  <div class="chart-card">
    <h5>Score Trends Across Attempts</h5>
    <div class="chart-container">
      <canvas id="progressChart"></canvas>
    </div>
  </div>

  <!-- Category Analysis -->
  <div class="section-header">
    <i class="fas fa-layer-group"></i>
    <h3>Category Performance</h3>
  </div>
  <div class="row g-4">
    <div class="col-lg-7">
      <div class="chart-card">
        <h5>Category Breakdown (All Attempts)</h5>
        <div class="chart-container chart-container-tall">
          <canvas id="catCountsChart"></canvas>
        </div>
      </div>
    </div>
    <div class="col-lg-5">
      <div class="chart-card">
        <h5>Accuracy by Category</h5>
        <div class="chart-container chart-container-tall">
          <canvas id="catAccuracyChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Actions -->
  <div class="text-center mt-4 mb-4">
    <a class="btn btn-success btn-lg me-2" href="{% url 'exam_results' %}?result_id={{ latest_result_id }}">
      <i class="fas fa-eye"></i> View Latest Result
    </a>
    <a href="{% url 'analytics_overview' %}" class="btn btn-outline-info btn-lg">
      <i class="fas fa-chart-bar"></i> Overall Analytics
    </a>
  </div>

  {% else %}
  <div class="text-center py-5">
    <div class="performance-indicator d-inline-flex">
      <div class="performance-icon">
        <i class="fas fa-clipboard-list" style="color: #95a5a6;"></i>
      </div>
      <div class="performance-text">
        <h3>No Data Yet</h3>
        <p>Take this exam to see your analytics and progress tracking</p>
      </div>
    </div>
    <div class="mt-4">
      <a href="{% url 'exam_detail' exam.id %}" class="btn btn-primary btn-lg">
        <i class="fas fa-play"></i> Start Exam
      </a>
    </div>
  </div>
  {% endif %}
</div>

{% if has_data %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
<script>
  // Progress over time with target line
  const progressData = {
    labels: {{ attempt_dates|safe }},
    datasets: [{
      label: 'Score (%)',
      data: {{ attempt_scores|safe }},
      borderColor: '#667eea',
      backgroundColor: 'rgba(102, 126, 234, 0.1)',
      tension: 0.4,
      fill: true,
      pointRadius: 6,
      pointHoverRadius: 8,
      pointBackgroundColor: '#667eea',
      pointBorderColor: '#fff',
      pointBorderWidth: 2
    }, {
      label: 'Moving Average',
      data: {{ moving_avg|safe }},
      borderColor: '#38ef7d',
      borderDash: [5, 5],
      borderWidth: 2,
      pointRadius: 0,
      tension: 0.4
    }]
  };

  new Chart(document.getElementById('progressChart'), {
    type: 'line',
    data: progressData,
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: true, position: 'top' },
        tooltip: {
          mode: 'index',
          intersect: false,
          backgroundColor: 'rgba(0, 0, 0, 0.8)',
          padding: 12,
          titleFont: { size: 14 },
          bodyFont: { size: 13 }
        },
        annotation: {
          annotations: {
            targetLine: {
              type: 'line',
              yMin: 85,
              yMax: 85,
              borderColor: '#e74c3c',
              borderWidth: 2,
              borderDash: [10, 5],
              label: {
                display: true,
                content: 'Target 85%',
                position: 'end',
                backgroundColor: '#e74c3c',
                color: 'white',
                font: { size: 11, weight: 'bold' }
              }
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          max: 100,
          grid: { color: 'rgba(0, 0, 0, 0.05)' },
          ticks: { callback: function(value) { return value + '%'; } }
        },
        x: { grid: { display: false } }
      }
    }
  });

  // Category counts
  const labels = {{ labels|safe }};
  const correctData = {{ correct_data|safe }};
  const incorrectData = {{ incorrect_data|safe }};
  const unansweredData = {{ unanswered_data|safe }};
  const noanswerData = {{ noanswer_data|safe }};
  const accuracyPct = {{ accuracy_pct|safe }};

  new Chart(document.getElementById('catCountsChart'), {
    type: 'bar',
    data: {
      labels,
      datasets: [
        { label: 'Correct', data: correctData, backgroundColor: '#2ecc71' },
        { label: 'Incorrect', data: incorrectData, backgroundColor: '#e74c3c' },
        { label: 'Unanswered', data: unansweredData, backgroundColor: '#f1c40f' },
        { label: 'No Answer', data: noanswerData, backgroundColor: '#95a5a6' },
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { position: 'bottom' } },
      indexAxis: 'y',
      scales: {
        x: { stacked: true, beginAtZero: true },
        y: { stacked: true, ticks: { autoSkip: false, font: { size: 12 } } }
      }
    }
  });

  // Category accuracy
  new Chart(document.getElementById('catAccuracyChart'), {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        label: 'Accuracy %',
        data: accuracyPct,
        backgroundColor: accuracyPct.map(v => v >= 85 ? '#2ecc71' : v >= 70 ? '#3498db' : v >= 60 ? '#f39c12' : '#e74c3c'),
        borderRadius: 8
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { 
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: function(context) {
              return context.parsed.x + '%';
            }
          }
        }
      },
      indexAxis: 'y',
      scales: {
        x: { beginAtZero: true, max: 100 },
        y: { ticks: { autoSkip: false, font: { size: 12 } } }
      }
    }
  });
</script>
{% endif %}
{% endblock %}