{% extends 'base.html' %} {% load static %} {% block page_content %}

<!-- 페이지 상단 헤더: 게시판 등 다른 페이지와 통일성을 줍니다. -->
<div class="header-section compact">
  <div class="header-overlay"></div>
  <div class="container text-center">
    <h1 class="page-title text-glow">Real-time Chat</h1>
    <p class="page-subtitle">실시간으로 대화를 나눠보세요.</p>
  </div>
</div>

<!-- 채팅 UI를 중앙에 배치하기 위한 컨테이너 -->
<div class="chat-page-container">
  <div class="chat-container">
    <div class="chat-header">
      <div class="header-left">
        <a href="{% url 'lobby' %}" class="back-btn" aria-label="Back to Lobby">
          <i class="fas fa-arrow-left"></i>
        </a>
        <h2 class="room-title">{{ room.name }}</h2>
      </div>
      {% if room.owner == user %}
      <div class="header-actions">
        <form
          method="POST"
          action="{% url 'delete_room' room_name=room.name %}"
        >
          {% csrf_token %}
          <button
            type="submit"
            class="btn delete-btn"
            aria-label="Delete Room"
            onclick="return confirm('정말로 이 채팅방을 삭제하시겠습니까?')"
          >
            <i class="fas fa-trash"></i>
          </button>
        </form>
      </div>
      {% endif %}
    </div>

    {% if requires_password %}
    <div class="password-form-container">
      <div class="password-form-card">
        <h4><i class="fas fa-lock me-2"></i>비밀번호 입력</h4>
        <form id="passwordForm">
          {% csrf_token %}
          <div class="form-floating mb-3">
            <input
              type="password"
              class="form-control"
              id="password"
              name="password"
              placeholder="Password"
              required
            />
            <label for="password">Password</label>
          </div>
          <button type="submit" class="btn btn-gradient w-100">입장하기</button>
          <div
            id="passwordError"
            class="text-danger mt-2"
            style="display: none"
          >
            비밀번호가 올바르지 않습니다.
          </div>
        </form>
      </div>
    </div>
    {% else %}
    <div class="chat-messages" id="chat-log">
      {% for message in messages %}
        {% if message.user == user %}
        <!-- 내 메시지 -->
        <div class="message message-own">
          <div class="message-bubble">
            <p class="message-content">{{ message.content|linebreaksbr }}</p>
            <span class="message-timestamp">{{ message.formatted_time }}</span>
          </div>
        </div>
        {% else %}
        <!-- 다른 사람 메시지 -->
        <div class="message message-other">
          <span class="message-author">{{ message.user.username }}</span>
          <div class="message-bubble">
            <p class="message-content">{{ message.content|linebreaksbr }}</p>
            <span class="message-timestamp">{{ message.formatted_time }}</span>
          </div>
        </div>
        {% endif %}
      {% endfor %}
    </div>

    <div class="chat-input-area">
      <form id="chat-message-form" class="d-flex w-100" method="POST">
        {% csrf_token %}
        <input
          type="text"
          id="chat-message-input"
          class="message-input"
          placeholder="메시지를 입력하세요..."
          autocomplete="off"
        />
        <button
          type="submit"
          id="chat-message-submit"
          class="send-btn"
          aria-label="Send Message"
        >
          <i class="fas fa-paper-plane"></i>
        </button>
      </form>
    </div>
    {% endif %}
  </div>
</div>

<!-- JavaScript 변수들을 숨겨진 input으로 전달 -->
<input type="hidden" id="room-name" value="{{ room.name }}">
<input type="hidden" id="user-username" value="{{ user.username }}">
<input type="hidden" id="requires-password" value="{% if requires_password %}true{% else %}false{% endif %}">

<script>
document.addEventListener('DOMContentLoaded', function() {
    // 비밀번호 폼이 있으면 WebSocket 연결하지 않음
    const requiresPassword = document.getElementById('requires-password').value === 'true';
    
    if (requiresPassword) {
        handlePasswordForm();
        return;
    }

    // WebSocket 연결 시작
    initializeChat();
});

function initializeChat() {
    const roomNameElement = document.getElementById('room-name');
    const userNameElement = document.getElementById('user-username');
    
    if (!roomNameElement || !userNameElement) {
        console.error('Required elements not found');
        return;
    }

    const roomName = roomNameElement.value;
    const userName = userNameElement.value;
    
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${protocol}//${window.location.host}/ws/chat/${roomName}/`;
    
    let chatSocket = new WebSocket(wsUrl);
    let isConnected = false;
    let reconnectAttempts = 0;
    const maxReconnectAttempts = 3;
    
    chatSocket.onopen = function(e) {
        isConnected = true;
        reconnectAttempts = 0;
        showConnectionStatus('연결됨', true);
    };
    
    chatSocket.onmessage = function(e) {
        try {
            const data = JSON.parse(e.data);
            
            if (data.error) {
                showErrorMessage(data.error);
                return;
            }
            
            addMessageToChat(data, userName);
        } catch (error) {
            console.error('Message parsing error:', error);
        }
    };
    
    chatSocket.onclose = function(e) {
        isConnected = false;
        showConnectionStatus('연결 끊김', false);
        
        if (e.code !== 1000 && reconnectAttempts < maxReconnectAttempts) {
            reconnectAttempts++;
            setTimeout(() => {
                if (!isConnected) {
                    location.reload();
                }
            }, 2000 * reconnectAttempts);
        }
    };
    
    chatSocket.onerror = function(e) {
        showConnectionStatus('연결 오류', false);
    };
    
    const messageForm = document.querySelector('#chat-message-form');
    const messageInput = document.querySelector('#chat-message-input');
    const submitButton = document.querySelector('#chat-message-submit');
    
    if (messageForm && messageInput && submitButton) {
        let isSubmitting = false;
        
        messageForm.onsubmit = function(e) {
            e.preventDefault();
            
            if (isSubmitting) {
                return;
            }
            
            const message = messageInput.value.trim();
            if (!message) return;
            
            if (!isConnected) {
                showErrorMessage('연결이 끊어져 있습니다. 잠시 후 다시 시도해주세요.');
                return;
            }
            
            isSubmitting = true;
            const originalIcon = submitButton.innerHTML;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            submitButton.disabled = true;
            
            try {
                chatSocket.send(JSON.stringify({
                    'message': message
                }));
                messageInput.value = '';
            } catch (error) {
                console.error('Send error:', error);
                showErrorMessage('메시지 전송에 실패했습니다.');
            } finally {
                setTimeout(() => {
                    isSubmitting = false;
                    submitButton.innerHTML = originalIcon;
                    submitButton.disabled = false;
                    messageInput.focus();
                }, 100);
            }
        };
        
        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey && !isSubmitting) {
                e.preventDefault();
                messageForm.dispatchEvent(new Event('submit'));
            }
        });
    }
}

function addMessageToChat(data, currentUser) {
    const chatLog = document.querySelector('#chat-log');
    if (!chatLog) {
        return;
    }
    
    const messageDiv = document.createElement('div');
    messageDiv.className = data.username === currentUser ? 'message message-own' : 'message message-other';
    
    let messageHTML;
    if (data.username === currentUser) {
        messageHTML = `
            <div class="message-bubble">
                <p class="message-content">${escapeHtml(data.message)}</p>
                <span class="message-timestamp">${data.timestamp}</span>
            </div>
        `;
    } else {
        messageHTML = `
            <span class="message-author">${escapeHtml(data.username)}</span>
            <div class="message-bubble">
                <p class="message-content">${escapeHtml(data.message)}</p>
                <span class="message-timestamp">${data.timestamp}</span>
            </div>
        `;
    }
    
    messageDiv.innerHTML = messageHTML;
    chatLog.appendChild(messageDiv);
    chatLog.scrollTop = chatLog.scrollHeight;
}

function showConnectionStatus(status, isConnected) {
    const header = document.querySelector('.chat-header .room-title');
    if (header) {
        if (isConnected) {
            header.style.color = '';
        } else {
            header.style.color = '#ff6b6b';
        }
    }
}

function showErrorMessage(message) {
    const chatLog = document.querySelector('#chat-log');
    if (chatLog) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error-message';
        errorDiv.innerHTML = `
            <div class="error-bubble">
                <i class="fas fa-exclamation-triangle"></i>
                ${message}
            </div>
        `;
        chatLog.appendChild(errorDiv);
        chatLog.scrollTop = chatLog.scrollHeight;
        
        setTimeout(() => {
            if (errorDiv.parentNode) {
                errorDiv.parentNode.removeChild(errorDiv);
            }
        }, 5000);
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML.replace(/\n/g, '<br>');
}

function handlePasswordForm() {
    const passwordForm = document.querySelector('#passwordForm');
    if (!passwordForm) {
        return;
    }
    
    passwordForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const password = document.querySelector('#password').value;
        const roomName = document.getElementById('room-name').value;
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const submitButton = this.querySelector('button[type="submit"]');
        const errorDiv = document.querySelector('#passwordError');
        
        const originalText = submitButton.innerHTML;
        submitButton.innerHTML = '확인 중...';
        submitButton.disabled = true;
        errorDiv.style.display = 'none';
        
        fetch(`/chat/check_password/${roomName}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': csrfToken
            },
            body: `password=${encodeURIComponent(password)}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                submitButton.innerHTML = '입장 중...';
                location.reload();
            } else {
                errorDiv.style.display = 'block';
                submitButton.innerHTML = originalText;
                submitButton.disabled = false;
            }
        })
        .catch(error => {
            console.error('Password check error:', error);
            errorDiv.textContent = '비밀번호 확인 중 오류가 발생했습니다.';
            errorDiv.style.display = 'block';
            submitButton.innerHTML = originalText;
            submitButton.disabled = false;
        });
    });
}

// 페이지 로드 시 스크롤을 아래로
window.addEventListener('load', function() {
    const chatLog = document.querySelector('#chat-log');
    if (chatLog) {
        chatLog.scrollTop = chatLog.scrollHeight;
    }
});
</script>

{% endblock page_content %}